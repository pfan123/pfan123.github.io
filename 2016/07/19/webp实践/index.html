<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>webp实践探究 | pfan博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="最近组内流行一股探讨webp的风潮，抱着实事求是的态度，本码农也开始了webp探究实践。先扫一下盲，提提WebP的优势。
WebP 的优势WebP 格式是 Google 于2010年发布的一种支持有损压缩和无损压缩的图片文件格式，派生自图像编码格式 VP8。它具有较优的图像数据压缩算法，能带来更小的图片体积，而且拥有肉眼识别无差异的图像质量，同时具备了无损和有损的压缩模式、Alpha 透明以及动画">
<meta property="og:type" content="article">
<meta property="og:title" content="webp实践探究">
<meta property="og:url" content="http://pfan123.github.io/2016/07/19/webp实践/index.html">
<meta property="og:site_name" content="pfan博客">
<meta property="og:description" content="最近组内流行一股探讨webp的风潮，抱着实事求是的态度，本码农也开始了webp探究实践。先扫一下盲，提提WebP的优势。
WebP 的优势WebP 格式是 Google 于2010年发布的一种支持有损压缩和无损压缩的图片文件格式，派生自图像编码格式 VP8。它具有较优的图像数据压缩算法，能带来更小的图片体积，而且拥有肉眼识别无差异的图像质量，同时具备了无损和有损的压缩模式、Alpha 透明以及动画">
<meta property="og:image" content="http://7xrig5.com1.z0.glb.clouddn.com/1.png">
<meta property="og:image" content="http://7xrig5.com1.z0.glb.clouddn.com/2.png">
<meta property="og:image" content="http://7xrig5.com1.z0.glb.clouddn.com/3.png">
<meta property="og:updated_time" content="2016-07-20T03:02:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="webp实践探究">
<meta name="twitter:description" content="最近组内流行一股探讨webp的风潮，抱着实事求是的态度，本码农也开始了webp探究实践。先扫一下盲，提提WebP的优势。
WebP 的优势WebP 格式是 Google 于2010年发布的一种支持有损压缩和无损压缩的图片文件格式，派生自图像编码格式 VP8。它具有较优的图像数据压缩算法，能带来更小的图片体积，而且拥有肉眼识别无差异的图像质量，同时具备了无损和有损的压缩模式、Alpha 透明以及动画">
<meta name="twitter:image" content="http://7xrig5.com1.z0.glb.clouddn.com/1.png">
  
    <link rel="alternative" href="/atom.xml" title="pfan博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://litten.github.io/assets/blogImg/litten.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">pfan</a></h1>
		</hgroup>

		
		<p class="header-subtitle">新起点，新高度</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>		
					
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>

			</div>
		


		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
				        	<li class = "article_cate_tit"> 文章分类</li>
				        	<li class = "article_cate_a"> <a  href = "/categories/技术杂谈/">技术杂谈</a>	</li>
				        	<li class = "article_cate_a"> <a href = "/categories/兴趣爱好/">兴趣爱好</a>		</li>
				        	<li class = "article_cate_a"> <a href = "/categories/日志/">日志</a></li>
				        	<li class = "article_cate_a"> <a href = "/categories/JavaScript/">JavaScript</a>	</li>
				        	<li class = "article_cate_a"> <a  href = "/categories/CSS3/">CSS3</a>	</li>
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/pfan123" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/gaolu1990/home?wvr=5" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>



				<style type="text/css">
					.article_cate_tit{
						color:#ba8f6c;
						margin-top:6px;
					}
					.article_cate_con a{
						display:block;
						font-size:12px;
						text-align:center;
						margin:4px 0;
					}
					#header .header-menu{
						line-height:21px;
					}
					.article_cate_a{
						line-height:18px !important;
					}	
					.article_cate_a a{
						font-size:12px !important;
					}				
					#container .left-col .overlay{
						height:130px;
					}
					.header-nav{
						top:160px;
					}
				</style>	
				<!-- E 新增模块-->
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/gitignore-git/" style="font-size: 10px;">.gitignore git</a> <a href="/tags/htaccess-配置二级域名-绑定子目录/" style="font-size: 10px;">.htaccess  配置二级域名  绑定子目录</a> <a href="/tags/AMD/" style="font-size: 10px;">AMD</a> <a href="/tags/CMD/" style="font-size: 10px;">CMD</a> <a href="/tags/CSS-BEM-OOCSS/" style="font-size: 10px;">CSS BEM OOCSS</a> <a href="/tags/CSS动画篇/" style="font-size: 10px;">CSS动画篇</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/ESLint/" style="font-size: 10px;">ESLint</a> <a href="/tags/Git，Git查看历史记录/" style="font-size: 10px;">Git，Git查看历史记录</a> <a href="/tags/H5/" style="font-size: 10px;">H5</a> <a href="/tags/H5-视频直播-video/" style="font-size: 10px;">H5 视频直播 video</a> <a href="/tags/H5全景、CSS3d、perspective/" style="font-size: 20px;">H5全景、CSS3d、perspective</a> <a href="/tags/HLS、RTMP协议/" style="font-size: 10px;">HLS、RTMP协议</a> <a href="/tags/HTML5/" style="font-size: 20px;">HTML5</a> <a href="/tags/HTML5-视频直播-video-canvas/" style="font-size: 10px;">HTML5 视频直播 video canvas</a> <a href="/tags/HTTP、-node-http-proxy、-nginx、-proxy/" style="font-size: 20px;">HTTP、 node-http-proxy、 nginx、 proxy</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Mac-命令-Terminal-osx/" style="font-size: 10px;">Mac 命令 Terminal osx</a> <a href="/tags/Mac、root/" style="font-size: 10px;">Mac、root</a> <a href="/tags/Math-atan-、Math-atan2-斜率/" style="font-size: 10px;">Math.atan()、Math.atan2() 斜率</a> <a href="/tags/Mongoose参考手册-MongoDB-数据库-node/" style="font-size: 10px;">Mongoose参考手册  MongoDB  数据库 node</a> <a href="/tags/Nginx-负载均衡/" style="font-size: 10px;">Nginx  负载均衡</a> <a href="/tags/Nginx-负载均衡-node-jdc-解决方案-host/" style="font-size: 10px;">Nginx  负载均衡 node  jdc 解决方案 host</a> <a href="/tags/Nginx-Mac-Node/" style="font-size: 10px;">Nginx Mac Node</a> <a href="/tags/Nginx-MySQL-PHP-FPM-Mac-OS/" style="font-size: 10px;">Nginx MySQL PHP-FPM Mac OS</a> <a href="/tags/Nodejs学习实践-nodejs-ES6/" style="font-size: 10px;">Nodejs学习实践 nodejs  ES6</a> <a href="/tags/PreloadJS-EaselJS-TweenJS-SoundJS/" style="font-size: 10px;">PreloadJS EaselJS TweenJS SoundJS</a> <a href="/tags/SVG-Sprites-Symbols/" style="font-size: 10px;">SVG Sprites Symbols</a> <a href="/tags/UMD/" style="font-size: 10px;">UMD</a> <a href="/tags/Vim-vi/" style="font-size: 10px;">Vim vi</a> <a href="/tags/createJS/" style="font-size: 10px;">createJS</a> <a href="/tags/css-modules-scope-模块化/" style="font-size: 10px;">css modules  scope  模块化</a> <a href="/tags/deviceorientation、orientationchange-重力感应/" style="font-size: 10px;">deviceorientation、orientationchange 重力感应</a> <a href="/tags/deviceorientation、orientationchange-重力感应-CSS3D/" style="font-size: 10px;">deviceorientation、orientationchange 重力感应 CSS3D</a> <a href="/tags/express/" style="font-size: 10px;">express</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/hexo初始/" style="font-size: 10px;">hexo初始</a> <a href="/tags/hexo相关问题/" style="font-size: 10px;">hexo相关问题</a> <a href="/tags/insertAdjacentHTML方法/" style="font-size: 10px;">insertAdjacentHTML方法</a> <a href="/tags/insertAdjacentText方法/" style="font-size: 10px;">insertAdjacentText方法</a> <a href="/tags/javascript、canvas、toDataURL/" style="font-size: 10px;">javascript、canvas、toDataURL()</a> <a href="/tags/mac-iphone-铃声/" style="font-size: 10px;">mac iphone 铃声</a> <a href="/tags/node-版本管理-nvm-n/" style="font-size: 10px;">node 版本管理  nvm  n</a> <a href="/tags/node-读写excel-JS-XLSX-分析excel写入/" style="font-size: 10px;">node 读写excel JS-XLSX 分析excel写入</a> <a href="/tags/pm2学习实践-nodejs-pm2/" style="font-size: 10px;">pm2学习实践 nodejs pm2</a> <a href="/tags/react-flux-redux-ECMAScript6-Vue-Angular-Angular2-0-NuclearJS/" style="font-size: 10px;">react flux redux ECMAScript6 Vue Angular Angular2.0 NuclearJS</a> <a href="/tags/ssh常用命令-SSH/" style="font-size: 10px;">ssh常用命令  SSH</a> <a href="/tags/video-canvas/" style="font-size: 10px;">video canvas</a> <a href="/tags/vue-router-vue/" style="font-size: 10px;">vue-router, vue</a> <a href="/tags/webp/" style="font-size: 10px;">webp</a> <a href="/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/tags/三角学、弧度、角度/" style="font-size: 10px;">三角学、弧度、角度</a> <a href="/tags/买房前必备知识-house-home/" style="font-size: 10px;">买房前必备知识  house home</a> <a href="/tags/买车前必备知识-car/" style="font-size: 10px;">买车前必备知识  car</a> <a href="/tags/京东购物H5活动CP重构规范/" style="font-size: 10px;">京东购物H5活动CP重构规范</a> <a href="/tags/优化JavaScript的执行效率/" style="font-size: 10px;">优化JavaScript的执行效率</a> <a href="/tags/前端性能优化/" style="font-size: 10px;">前端性能优化</a> <a href="/tags/吉他/" style="font-size: 10px;">吉他</a> <a href="/tags/吉他知识/" style="font-size: 10px;">吉他知识</a> <a href="/tags/学吉他知识集锦/" style="font-size: 10px;">学吉他知识集锦</a> <a href="/tags/旅游-帝都畅游-相约北京/" style="font-size: 10px;">旅游 帝都畅游 相约北京</a> <a href="/tags/模块的写法/" style="font-size: 10px;">模块的写法</a> <a href="/tags/运营规范/" style="font-size: 10px;">运营规范</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/pingfan1990/">博客园博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.w3cfuns.com/house.php">前端网博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://pingfan1990.sinaapp.com/">pfan展示平台</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://doc.pfan123.com/">pfan前端开发导航平台</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">因上努力，果上随缘</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">pfan</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://litten.github.io/assets/blogImg/litten.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">pfan</h1>
			</hgroup>
			
			<p class="header-subtitle">新起点，新高度</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/pfan123" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/gaolu1990/home?wvr=5" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-webp实践" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/19/webp实践/" class="article-date">
  	<time datetime="2016-07-19T03:51:43.000Z" itemprop="datePublished">2016-07-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      webp实践探究
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webp/">webp</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近组内流行一股探讨webp的风潮，抱着实事求是的态度，本码农也开始了webp探究实践。先扫一下盲，提提WebP的优势。</p>
<h2 id="WebP-的优势"><a href="#WebP-的优势" class="headerlink" title="WebP 的优势"></a>WebP 的优势</h2><p>WebP 格式是 Google 于2010年发布的一种支持有损压缩和无损压缩的图片文件格式，派生自图像编码格式 VP8。它具有较优的图像数据压缩算法，能带来更小的图片体积，而且拥有肉眼识别无差异的图像质量，同时具备了无损和有损的压缩模式、Alpha 透明以及动画的特性，在 JPEG 和 PNG 上的转化效果都非常优秀、稳定和统一。目前，知名网站 Youtube 、Facebook、Ebay 等均有使用 WebP格式。</p>
<p>WebP 集合了多种图片文件格式的特点，JPEG 适合压缩照片和其他细节丰富的图片，GIF 可以显示动态图片，PNG 支持透明图像，图片色彩非常丰富，而 WebP 则兼具上述优点，且较于它们还有更出色的地方。</p>
<p>据 Google 测试，无损压缩后的 WebP 比 PNG 文件少了 45% 的文件大小，即使 PNG 文件经过其他压缩工具压缩后，WebP 还是可以减少 28% 的文件大小。此外，与 JPEG 相比，在质量相同的情况下，WebP 格式图像的体积要比 JPEG 格式图像小 40%，而 WebP 在压缩方面比 JPEG 格式更优越。    </p>
<h2 id="Webp-转换工具"><a href="#Webp-转换工具" class="headerlink" title="Webp 转换工具"></a>Webp 转换工具</h2><p>看了我组恩鑫大大的<a href="http://mtd.jd.com/wiki/doku.php?id=blog:2016:07:png_%E8%BD%AC_webp_%E7%9A%84%E6%AD%A3%E7%A1%AE%E6%96%B9%E5%BC%8F" target="_blank" rel="external">png 转 webp 的正确姿势</a>，知道了<a href="https://developers.google.com/speed/webp/" target="_blank" rel="external">WebP Converter工具</a>转换webp的效率是比较高的。</p>
<p>webP Converter工具安装是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo brew install webp</span><br></pre></td></tr></table></figure>
<p>转换webp命令是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cwebp -q 80 image.png -o image.webp</span><br></pre></td></tr></table></figure>
<p>知道了，google提供的工具转换效率高，以及使用方式，鉴于工程化、批量化、敏捷开发的原则，我进行了如下猜想使其达到批量生产的目的：</p>
<p>猜测一：  cwebp命令后面匹配多个参数进行批量转换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cwebp -q 80 image.png -o image.webp -q 80 logo.png -o logo.webp</span><br></pre></td></tr></table></figure>
<p>抱着大大的希望，结果发现，只能转换最后一个图片，只能转换最后一个图片，只能转换最后一个图片，重要的事情说三遍，整个人不好了……</p>
<p>猜测二：通过child_process模块，开子进程，来执行格式webp转换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">const child_process  = require(&quot;child_process&quot;);</span><br><span class="line">const fs = require(&quot;fs&quot;);</span><br><span class="line">const path = require(&quot;path&quot;);</span><br><span class="line">const curPath = process.cwd();</span><br><span class="line"></span><br><span class="line">function convertWep(opt)&#123;</span><br><span class="line">	var src = opt.src, quality = opt.quality || 60;</span><br><span class="line"></span><br><span class="line">    if(fs.existsSync(src))&#123;</span><br><span class="line">        fs.readdir(src,(err,files) =&gt; &#123;</span><br><span class="line">            if(err)&#123;console.log(err);return;&#125;</span><br><span class="line">            files.forEach(function(filename)&#123;</span><br><span class="line">            </span><br><span class="line">                var url = path.join(src,filename);</span><br><span class="line"></span><br><span class="line">                fs.stat(url,(err, stats) =&gt; &#123;</span><br><span class="line">                    if (err) throw err;</span><br><span class="line">                    </span><br><span class="line">                    if(stats.isFile())&#123;</span><br><span class="line">                    	//不支持bmp格式</span><br><span class="line">                        if(/.*\.png|jpg|gif$/.test(url))&#123;</span><br><span class="line">                        </span><br><span class="line">                        	var webpsrc = url.split(&apos;.&apos;)[0]+&quot;.webp&quot;;</span><br><span class="line">                        	childWebp(path.join(curPath,url),quality,path.join(curPath,webpsrc))</span><br><span class="line">                        	console.log(filename+&quot; 转换webp格式成功&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;else if(stats.isDirectory())&#123;</span><br><span class="line">                        convertWep(&#123;</span><br><span class="line">							&quot;src&quot;:url,</span><br><span class="line">							&quot;quality&quot;:quality                        	</span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        console.log(&quot;给定的目录不存，读取不到文件&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function childWebp(src , quality,webpsrc)&#123;</span><br><span class="line">	child_process.exec(&quot;cwebp -q &quot;+quality+&quot; &quot;+src+&quot; -o &quot;+webpsrc,(error, stdout, stderr) =&gt; &#123;</span><br><span class="line">	    if (error) &#123;</span><br><span class="line">	      console.log(error.stack);</span><br><span class="line">	      console.log(&apos;Error code: &apos; + error.code);</span><br><span class="line">	      return ;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">convertWep(&#123;</span><br><span class="line">	src:&quot;./images/&quot;,</span><br><span class="line">	quality:60</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>转换结果：<br><img src="http://7xrig5.com1.z0.glb.clouddn.com/1.png" alt="child_process开进程转换结果"></p>
<p>方法原理就是给每个图片单独开子进程进行转换，看结果可以达到批量转换不同质量的webp格式的目的，但是不够优雅，无法达到监测每个图片转换情况，无法监测图片转换完成，以及无法关闭所开的子进程。</p>
<h3 id="gulp-webp转换工具"><a href="#gulp-webp转换工具" class="headerlink" title="gulp-webp转换工具"></a>gulp-webp转换工具</h3><p>本着码农朋友不作死、不服输的精神，反复查阅资料找寻其他自动化转换webp工具，我发现了<a href="https://github.com/sindresorhus/gulp-webp" target="_blank" rel="external">gulp-webp</a>插件也可以达到批量转换，支持 <code>PNG</code>、<code>JPEG</code>、<code>TIFF</code>格式转换，并且转换率基本一致。</p>
<p>使用示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const gulp = require(&apos;gulp&apos;);</span><br><span class="line">const webp = require(&apos;gulp-webp&apos;);</span><br><span class="line"></span><br><span class="line">gulp.task(&apos;default&apos;, () =&gt;</span><br><span class="line">    gulp.src(&apos;./images/*.&#123;png,jpg,jpeg&#125;&apos;)</span><br><span class="line">        .pipe(webp(&#123;quality: 60&#125;))</span><br><span class="line">        .pipe(gulp.dest(&apos;./dist&apos;))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>简单看看，示例代码，感觉还是很优雅的，但使用时发现无法提供转换webp具体提示，这点糟透了：<br>执行结果：<br><img src="http://7xrig5.com1.z0.glb.clouddn.com/2.png" alt="child_process开进程转换结果"></p>
<p>gulp-webp与WebP Converter转换率对比:<br><code>WebP Converter</code>: 0.4.3<br><code>gulp-webp</code>: 2.3.0<br>原图： bg.jpg (34.176K)，test.png(141.071K)</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>质量</th>
<th>gulp-webp</th>
<th>WebP Converter</th>
</tr>
</thead>
<tbody>
<tr>
<td>bg.jpg</td>
<td>90%</td>
<td>21.344K</td>
<td>21.344K</td>
</tr>
<tr>
<td></td>
<td>80%</td>
<td>10.250K</td>
<td>10.250K</td>
</tr>
<tr>
<td></td>
<td>70%</td>
<td>7.550K</td>
<td>7.550K</td>
</tr>
<tr>
<td></td>
<td>60%</td>
<td>6.856K</td>
<td>6.856K</td>
</tr>
<tr>
<td></td>
<td>50%</td>
<td>6.034K</td>
<td>6.034K</td>
</tr>
<tr>
<td>test.png</td>
<td>90%</td>
<td>48.390K</td>
<td>48.710K</td>
</tr>
<tr>
<td></td>
<td>80%</td>
<td>29.584K</td>
<td>29.584K</td>
</tr>
<tr>
<td></td>
<td>70%</td>
<td>23.240K</td>
<td>23.240K</td>
</tr>
<tr>
<td></td>
<td>60%</td>
<td>20.734K</td>
<td>20.734K</td>
</tr>
<tr>
<td></td>
<td>50%</td>
<td>18.332K</td>
<td>18.332K</td>
</tr>
</tbody>
</table>
<p>对比结果得出，gulp-webp与WebP Converter转换率基本是一致的，于是乎猜想难道它们使用额转换原理一样。抱着这个猜想，开始了分析<code>gulp-webp</code>转换原理。</p>
<p><code>gulp-webp</code>中 API 提到：</p>
<blockquote>
<p>webp([options])</p>
<p>See the <a href="https://github.com/imagemin/imagemin-webp#imageminwebpoptions" target="_blank" rel="external">imagemin-webp</a> options.</p>
</blockquote>
<p>查看<code>imagemin-webp</code>模块中发现，其中转换模块最终是利用<code>cwebp-bin</code>实现，其原理也是对图片单开子进程实现转换：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var execFile = require(&apos;child_process&apos;).execFile;</span><br><span class="line">var cwebp = require(&apos;cwebp-bin&apos;);</span><br><span class="line"></span><br><span class="line">execFile(cwebp, [&apos;input.png&apos;, &apos;-o&apos;, &apos;output.webp&apos;], function (err) &#123;</span><br><span class="line">    if (err) &#123;</span><br><span class="line">        throw err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    console.log(&apos;Image is converted!&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>结合webp官网给出解释：</p>
<blockquote>
<p>WebP includes the lightweight encoding and decoding library libwebp and the command line tools cwebp and dwebp for converting images to and from the WebP format, as well as tools for viewing, muxing and animating WebP images. The full source code is available on the download page.</p>
</blockquote>
<p>最终结论，<code>WebP Converter</code>与<code>gulp-webp</code>转换webp的核心模块都是<code>cwebp-bin</code>，实现原理、转换效率基本都是一样，所以在使用webp批量转换上，使用gulp-webp插件或前面我提到的第二种猜想方法，都可以达到目的，具体使用可结合个人喜好选用。</p>
<h2 id="Webp-实例使用"><a href="#Webp-实例使用" class="headerlink" title="Webp 实例使用"></a>Webp 实例使用</h2><p>本码农再次本着实事求是的心态，深挖总结webp在项目中实际使用。具体使用方案如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">//注意此脚本需放在样式前面</span><br><span class="line"> checkWebp();</span><br><span class="line"> </span><br><span class="line"> function checkWebp()&#123;</span><br><span class="line">      var img = new Image();</span><br><span class="line">      img.onload = function()&#123;</span><br><span class="line">         if(img.width &gt; 0 &amp;&amp; img.height &gt; 0)&#123;</span><br><span class="line">           document.documentElement.className = &quot;webp&quot;;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      img.onerror = function()&#123;&#125;</span><br><span class="line">      img.src = &quot;data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA&quot;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/201607/sns808/css/style.css&quot;&gt;</span><br><span class="line"></span><br><span class="line"> &lt;div class=&quot;wrapper&quot;&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"> //样式代码片段</span><br><span class="line"> .wrapper&#123;</span><br><span class="line">    position: relative;</span><br><span class="line">    width:pxTorem(750px);</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    margin:0 auto;</span><br><span class="line">    background:image-url(&quot;bg.jpg&quot;) no-repeat;</span><br><span class="line">    background-size:cover;</span><br><span class="line">&#125;</span><br><span class="line">.webp&#123;</span><br><span class="line">    .wrapper&#123;</span><br><span class="line">        background:image-url(&quot;bg.webp&quot;) no-repeat;</span><br><span class="line">        background-size:cover;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过chrome控制台观察结果：</p>
<p><img src="http://7xrig5.com1.z0.glb.clouddn.com/3.png" alt="实践结果"></p>
<p>通过浏览器的自动运算判断，只加载了对应使用的资源，从而达到减少加载资源、提高加载效率的目的。</p>
<p>参考资料：</p>
<ul>
<li><a href="https://github.com/sindresorhus/gulp-webp" target="_blank" rel="external">gulp-webp转换工具</a></li>
<li><a href="https://github.com/imagemin/imagemin-webp#imageminwebpoptions" target="_blank" rel="external">imagemin-webp包装 cwebp-bin</a></li>
<li><a href="https://github.com/imagemin/cwebp-bin" target="_blank" rel="external">底层转换cwebp-bin</a></li>
<li><a href="https://www.npmjs.com/package/webpcss" target="_blank" rel="external">webpcss</a></li>
<li><a href="http://blog.qiniu.com/archives/5793" target="_blank" rel="external">七牛云图片处理实践｜带你认识 WEBP</a></li>
<li><a href="http://7b1fp7.com2.z0.glb.clouddn.com/%E4%B8%83%E7%89%9B%E5%8A%A8%E6%80%81WebP%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97.pdf" target="_blank" rel="external">七牛动态WebP使用指南.pdf</a></li>
</ul>

      
    </div>

    <!-- S 打赏模块 -->
    <div class="pfan_payment" style="max-width: 500px;margin: 0 auto">
        <img src="http://img.pfan123.com/payment.png" alt="" style="width: 100%;height: 10%;">
    </div>
    <!-- E 打赏模块 -->


    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/07/24/通过.htaccess文件将二级域名绑定到子目录/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          通过.htaccess文件配置二级域名绑定子目录
        
      </div>
    </a>
  
  
    <a href="/2016/07/18/Canvas实时处理Video预研/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Canvas实时处理Video预研</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

    
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="webp实践" data-title="webp实践探究" data-url="http://pfan123.github.io/2016/07/19/webp实践/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>






</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 pfan
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a>
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>