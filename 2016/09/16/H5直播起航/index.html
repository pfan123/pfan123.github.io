<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>H5直播起航 | pfan博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言前不久抽空对目前比较火的视频直播，做了下研究与探索，了解其整体实现流程，以及探讨移动端HTML5直播可行性方案。
发现目前 WEB 上主流的视频直播方案有 HLS 和 RTMP，移动 WEB 端目以HLS为主（HLS存在延迟性问题，也可以借助 video.js  采用RTMP），PC端则以RTMP为主实时性较好，接下来将围绕这两种视频流协议来展开H5直播主题分享。
一、视频流协议HLS与RT">
<meta property="og:type" content="article">
<meta property="og:title" content="H5直播起航">
<meta property="og:url" content="http://pfan123.github.io/2016/09/16/H5直播起航/index.html">
<meta property="og:site_name" content="pfan博客">
<meta property="og:description" content="前言前不久抽空对目前比较火的视频直播，做了下研究与探索，了解其整体实现流程，以及探讨移动端HTML5直播可行性方案。
发现目前 WEB 上主流的视频直播方案有 HLS 和 RTMP，移动 WEB 端目以HLS为主（HLS存在延迟性问题，也可以借助 video.js  采用RTMP），PC端则以RTMP为主实时性较好，接下来将围绕这两种视频流协议来展开H5直播主题分享。
一、视频流协议HLS与RT">
<meta property="og:image" content="http://pfan123.github.io/img/hls/banner.jpg">
<meta property="og:image" content="http://pfan123.github.io/img/hls/1.png">
<meta property="og:image" content="http://pfan123.github.io/img/hls/2.png">
<meta property="og:image" content="http://pfan123.github.io/img/hls/3.png">
<meta property="og:image" content="http://pfan123.github.io/img/hls/4.png">
<meta property="og:updated_time" content="2016-10-09T06:20:44.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="H5直播起航">
<meta name="twitter:description" content="前言前不久抽空对目前比较火的视频直播，做了下研究与探索，了解其整体实现流程，以及探讨移动端HTML5直播可行性方案。
发现目前 WEB 上主流的视频直播方案有 HLS 和 RTMP，移动 WEB 端目以HLS为主（HLS存在延迟性问题，也可以借助 video.js  采用RTMP），PC端则以RTMP为主实时性较好，接下来将围绕这两种视频流协议来展开H5直播主题分享。
一、视频流协议HLS与RT">
<meta name="twitter:image" content="http://pfan123.github.io/img/hls/banner.jpg">
  
    <link rel="alternative" href="/atom.xml" title="pfan博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://litten.github.io/assets/blogImg/litten.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">pfan</a></h1>
		</hgroup>

		
		<p class="header-subtitle">新起点，新高度</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>		
					
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>

			</div>
		


		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
				        	<li class = "article_cate_tit"> 文章分类</li>
				        	<li class = "article_cate_a"> <a  href = "/categories/技术杂谈/">技术杂谈</a>	</li>
				        	<li class = "article_cate_a"> <a href = "/categories/兴趣爱好/">兴趣爱好</a>		</li>
				        	<li class = "article_cate_a"> <a href = "/categories/日志/">日志</a></li>
				        	<li class = "article_cate_a"> <a href = "/categories/JavaScript/">JavaScript</a>	</li>
				        	<li class = "article_cate_a"> <a  href = "/categories/CSS3/">CSS3</a>	</li>
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/pfan123" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/gaolu1990/home?wvr=5" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>



				<style type="text/css">
					.article_cate_tit{
						color:#ba8f6c;
						margin-top:6px;
					}
					.article_cate_con a{
						display:block;
						font-size:12px;
						text-align:center;
						margin:4px 0;
					}
					#header .header-menu{
						line-height:21px;
					}
					.article_cate_a{
						line-height:18px !important;
					}	
					.article_cate_a a{
						font-size:12px !important;
					}				
					#container .left-col .overlay{
						height:130px;
					}
					.header-nav{
						top:160px;
					}
				</style>	
				<!-- E 新增模块-->
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/gitignore-git/" style="font-size: 10px;">.gitignore git</a> <a href="/tags/htaccess-配置二级域名-绑定子目录/" style="font-size: 10px;">.htaccess  配置二级域名  绑定子目录</a> <a href="/tags/AMD/" style="font-size: 10px;">AMD</a> <a href="/tags/CMD/" style="font-size: 10px;">CMD</a> <a href="/tags/CSS动画篇/" style="font-size: 10px;">CSS动画篇</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/ESLint/" style="font-size: 10px;">ESLint</a> <a href="/tags/H5/" style="font-size: 10px;">H5</a> <a href="/tags/H5-视频直播-video/" style="font-size: 10px;">H5 视频直播 video</a> <a href="/tags/HLS、RTMP协议/" style="font-size: 10px;">HLS、RTMP协议</a> <a href="/tags/HTML5/" style="font-size: 20px;">HTML5</a> <a href="/tags/HTML5-视频直播-video-canvas/" style="font-size: 10px;">HTML5 视频直播 video canvas</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Mac-命令-Terminal-osx/" style="font-size: 10px;">Mac 命令 Terminal osx</a> <a href="/tags/Mongoose参考手册-MongoDB-数据库-node/" style="font-size: 10px;">Mongoose参考手册  MongoDB  数据库 node</a> <a href="/tags/Nginx-负载均衡/" style="font-size: 10px;">Nginx  负载均衡</a> <a href="/tags/Nginx-负载均衡-node-jdc-解决方案-host/" style="font-size: 10px;">Nginx  负载均衡 node  jdc 解决方案 host</a> <a href="/tags/Nginx-Mac-Node/" style="font-size: 10px;">Nginx Mac Node</a> <a href="/tags/Nginx-MySQL-PHP-FPM-Mac-OS/" style="font-size: 10px;">Nginx MySQL PHP-FPM Mac OS</a> <a href="/tags/Nodejs学习实践-nodejs-ES6/" style="font-size: 10px;">Nodejs学习实践 nodejs  ES6</a> <a href="/tags/PreloadJS-EaselJS-TweenJS-SoundJS/" style="font-size: 10px;">PreloadJS EaselJS TweenJS SoundJS</a> <a href="/tags/SVG-Sprites-Symbols/" style="font-size: 10px;">SVG Sprites Symbols</a> <a href="/tags/UMD/" style="font-size: 10px;">UMD</a> <a href="/tags/Vim-vi/" style="font-size: 10px;">Vim vi</a> <a href="/tags/createJS/" style="font-size: 10px;">createJS</a> <a href="/tags/css-modules-scope-模块化/" style="font-size: 10px;">css modules  scope  模块化</a> <a href="/tags/express/" style="font-size: 10px;">express</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/hexo初始/" style="font-size: 10px;">hexo初始</a> <a href="/tags/hexo相关问题/" style="font-size: 10px;">hexo相关问题</a> <a href="/tags/insertAdjacentHTML方法/" style="font-size: 10px;">insertAdjacentHTML方法</a> <a href="/tags/insertAdjacentText方法/" style="font-size: 10px;">insertAdjacentText方法</a> <a href="/tags/mac-iphone-铃声/" style="font-size: 10px;">mac iphone 铃声</a> <a href="/tags/node-版本管理-nvm-n/" style="font-size: 10px;">node 版本管理  nvm  n</a> <a href="/tags/node-读写excel-JS-XLSX-分析excel写入/" style="font-size: 10px;">node 读写excel JS-XLSX 分析excel写入</a> <a href="/tags/pm2学习实践-nodejs-pm2/" style="font-size: 10px;">pm2学习实践 nodejs pm2</a> <a href="/tags/react-flux-redux-ECMAScript6-Vue-Angular-Angular2-0-NuclearJS/" style="font-size: 10px;">react flux redux ECMAScript6 Vue Angular Angular2.0 NuclearJS</a> <a href="/tags/ssh常用命令-SSH/" style="font-size: 10px;">ssh常用命令  SSH</a> <a href="/tags/video-canvas/" style="font-size: 10px;">video canvas</a> <a href="/tags/webp/" style="font-size: 10px;">webp</a> <a href="/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/tags/买房前必备知识-house-home/" style="font-size: 10px;">买房前必备知识  house home</a> <a href="/tags/买车前必备知识-car/" style="font-size: 10px;">买车前必备知识  car</a> <a href="/tags/京东购物H5活动CP重构规范/" style="font-size: 10px;">京东购物H5活动CP重构规范</a> <a href="/tags/优化JavaScript的执行效率/" style="font-size: 10px;">优化JavaScript的执行效率</a> <a href="/tags/前端性能优化/" style="font-size: 10px;">前端性能优化</a> <a href="/tags/吉他/" style="font-size: 10px;">吉他</a> <a href="/tags/吉他知识/" style="font-size: 10px;">吉他知识</a> <a href="/tags/学吉他知识集锦/" style="font-size: 10px;">学吉他知识集锦</a> <a href="/tags/旅游-帝都畅游-相约北京/" style="font-size: 10px;">旅游 帝都畅游 相约北京</a> <a href="/tags/模块的写法/" style="font-size: 10px;">模块的写法</a> <a href="/tags/运营规范/" style="font-size: 10px;">运营规范</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/pingfan1990/">博客园博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.w3cfuns.com/house.php">前端网博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://pingfan1990.sinaapp.com/">pfan展示平台</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://doc.pfan123.com/">pfan前端开发导航平台</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">因上努力，果上随缘</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">pfan</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://litten.github.io/assets/blogImg/litten.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">pfan</h1>
			</hgroup>
			
			<p class="header-subtitle">新起点，新高度</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/pfan123" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/gaolu1990/home?wvr=5" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-H5直播起航" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/09/16/H5直播起航/" class="article-date">
  	<time datetime="2016-09-16T03:51:43.000Z" itemprop="datePublished">2016-09-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      H5直播起航
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/H5/">H5</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/H5-视频直播-video/">H5 视频直播 video</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HLS、RTMP协议/">HLS、RTMP协议</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/img/hls/banner.jpg" alt="直播起航"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前不久抽空对目前比较火的视频直播，做了下研究与探索，了解其整体实现流程，以及探讨移动端HTML5直播可行性方案。</p>
<p>发现目前 WEB 上主流的视频直播方案有 HLS 和 RTMP，移动 WEB 端目以HLS为主（HLS存在延迟性问题，也可以借助 <a href="https://github.com/videojs/video.js" target="_blank" rel="external">video.js</a>  采用RTMP），PC端则以RTMP为主实时性较好，接下来将围绕这两种视频流协议来展开H5直播主题分享。</p>
<h2 id="一、视频流协议HLS与RTMP"><a href="#一、视频流协议HLS与RTMP" class="headerlink" title="一、视频流协议HLS与RTMP"></a>一、视频流协议HLS与RTMP</h2><h3 id="1）HTTP-Live-Streaming"><a href="#1）HTTP-Live-Streaming" class="headerlink" title="1）HTTP Live Streaming"></a>1）HTTP Live Streaming</h3><p>HTTP Live Streaming（简称 HLS）是一个基于 HTTP 的视频流协议，由 Apple 公司实现，Mac OS 上的 QuickTime、Safari 以及 iOS 上的 Safari 都能很好的支持 HLS，高版本 Android 也增加了对 HLS 的支持。一些常见的客户端如：MPlayerX、VLC 也都支持 HLS 协议。</p>
<p>HLS 协议基于 HTTP，而一个提供 HLS 的服务器需要做两件事：</p>
<ul>
<li>编码：以 H.263 格式对图像进行编码，以 MP3 或者 HE-AAC 对声音进行编码，最终打包到 MPEG-2 TS（Transport Stream）容器之中；</li>
<li>分割：把编码好的 TS 文件等长切分成后缀为 ts 的小文件，并生成一个 .m3u8 的纯文本索引文件；</li>
</ul>
<p>浏览器使用的是 m3u8 文件。m3u8 跟音频列表格式 m3u 很像，可以简单的认为 m3u8 就是包含多个 ts 文件的播放列表。播放器按顺序逐个播放，全部放完再请求一下 m3u8 文件，获得包含最新 ts 文件的播放列表继续播，周而复始。整个直播过程就是依靠一个不断更新的 m3u8 和一堆小的 ts 文件组成，m3u8 必须动态更新，ts 可以走 CDN。一个典型的 m3u8 文件格式如下：</p>
<blockquote>
<p>#EXTM3U</p>
<p>#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=200000<br>gear1/prog_index.m3u8</p>
<p>#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=311111<br>gear2/prog_index.m3u8</p>
<p>#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=484444<br>gear3/prog_index.m3u8</p>
<p>#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=737777<br>gear4/prog_index.m3u8</p>
</blockquote>
<p>可以看到 HLS 协议本质还是一个个的 HTTP 请求 / 响应，所以适应性很好，不会受到防火墙影响。但它也有一个致命的弱点：延迟现象非常明显。如果每个 ts 按照 5 秒来切分，一个 m3u8 放 6 个 ts 索引，那么至少就会带来 30 秒的延迟。如果减少每个 ts 的长度，减少 m3u8 中的索引数，延时确实会减少，但会带来更频繁的缓冲，对服务端的请求压力也会成倍增加。所以只能根据实际情况找到一个折中的点。</p>
<p>对于支持 HLS 的浏览器来说，直接这样写就能播放了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;video src=&quot;http://devimages.apple.com/iphone/samples/bipbop/bipbopall.m3u8&quot;</span><br><span class="line">height=&quot;300&quot; width=&quot;400&quot;  preload=&quot;auto&quot; autoplay=&quot;autoplay&quot; loop=&quot;loop&quot; webkit-playsinline=&quot;true&quot;&gt;&lt;/video&gt;</span><br></pre></td></tr></table></figure>
<p><code>注意</code>：hls在pc端仅支持safari浏览器，类似chrome浏览器使用<code>HTML5 video</code>标签无法播放m3u8格式，可直接采用网上一些比较成熟的方案，如：<a href="https://github.com/jackzhang1204/sewise-player" target="_blank" rel="external">sewise-player</a>、<a href="https://github.com/johndyer/mediaelement" target="_blank" rel="external">MediaElement</a>、<a href="https://github.com/videojs/videojs-contrib-hls" target="_blank" rel="external">videojs-contrib-hls</a>、<a href="https://github.com/jwplayer/jwplayer" target="_blank" rel="external">jwplayer</a>。</p>
<h3 id="2）Real-Time-Messaging-Protocol"><a href="#2）Real-Time-Messaging-Protocol" class="headerlink" title="2）Real Time Messaging Protocol"></a>2）Real Time Messaging Protocol</h3><p>Real Time Messaging Protocol（简称 RTMP）是 Macromedia 开发的一套视频直播协议，现在属于 Adobe。这套方案需要搭建专门的 RTMP 流媒体服务如 Adobe Media Server，并且在浏览器中只能使用 Flash 实现播放器。它的实时性非常好，延迟很小，但无法支持移动端 WEB 播放是它的硬伤。</p>
<p>虽然无法再ios的H5页面播放，但是对于ios原生应用是可以自己写解码去解析的, rtmp延迟低、实时性较好。</p>
<p>浏览器端，<code>HTML5 video</code>标签无法播放rtmp协议的视频，可以通过 <a href="https://github.com/videojs/video.js" target="_blank" rel="external">video.js</a> 来实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;link href=&quot;http://vjs.zencdn.net/5.8.8/video-js.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;video id=&quot;example_video_1&quot; class=&quot;video-js vjs-default-skin&quot; controls preload=&quot;auto&quot; width=&quot;640&quot; height=&quot;264&quot; loop=&quot;loop&quot; webkit-playsinline&gt;</span><br><span class="line">	&lt;source src=&quot;rtmp://10.14.221.17:1935/rtmplive/home&quot; type=&apos;rtmp/flv&apos;&gt;</span><br><span class="line">&lt;/video&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src=&quot;http://vjs.zencdn.net/5.8.8/video.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">videojs.options.flash.swf = &apos;video.swf&apos;;</span><br><span class="line">videojs(&apos;example_video_1&apos;).ready(function() &#123;</span><br><span class="line">  this.play();</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="3）视频流协议HLS与RTMP对比"><a href="#3）视频流协议HLS与RTMP对比" class="headerlink" title="3）视频流协议HLS与RTMP对比"></a>3）视频流协议HLS与RTMP对比</h3><table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">协议</th>
<th style="text-align:center">原理</th>
<th style="text-align:center">延时</th>
<th style="text-align:center">优点</th>
<th style="text-align:center">使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">HLS</td>
<td style="text-align:center">短链接http</td>
<td style="text-align:center">集合一段时间数据生成ts切片文件更新m3u8文件</td>
<td style="text-align:center">10s - 30s</td>
<td style="text-align:center">跨平台</td>
<td style="text-align:center">移动端为主</td>
</tr>
<tr>
<td style="text-align:center">RTMP</td>
<td style="text-align:center">长链接tcp</td>
<td style="text-align:center">每个时刻的数据收到后立即发送</td>
<td style="text-align:center">2s</td>
<td style="text-align:center">延时低、实时性好</td>
<td style="text-align:center">PC+直播+实时性要求高＋互动性强</td>
</tr>
</tbody>
</table>
<h2 id="二、直播形式"><a href="#二、直播形式" class="headerlink" title="二、直播形式"></a>二、直播形式</h2><p><img src="/img/hls/1.png" alt="直播形式"></p>
<p>目前直播展示形式，通常以YY直播、映客直播这种页面居多，可以看到其结构可以分成三层：① 背景视频层 ② 关注、评论模块 ③ 点赞动画</p>
<p>而现行H5类似直播页面，实现技术难点不大，其可以通过实现方式分为：① 底部视频背景使用video视频标签实现播放 ② 关注、评论模块利用 webscoket 来实时发送和接收新的消息通过DOM 和 CSS3 实现  ③ 点赞利用css3动画</p>
<p>了解完直播形式之后，接下来整体了解直播流程。</p>
<h2 id="三、直播整体流程"><a href="#三、直播整体流程" class="headerlink" title="三、直播整体流程"></a>三、直播整体流程</h2><p>直播整体流程大致可分为：</p>
<ul>
<li><p>① 视频采集端：可以是电脑上的音视频输入设备、或手机端的摄像头、或麦克风，目前以移动端手机视频为主。</p>
</li>
<li><p>② 直播流视频服务端：一台Nginx服务器，采集视频录制端传输的视频流(H264/ACC编码)，由服务器端进行解析编码，推送RTMP/HLS格式视频流至视频播放端。</p>
</li>
<li><p>③ 视频播放端：可以是电脑上的播放器（QuickTime Player、VLC），手机端的native播放器，还有就是h5的video标签等，目前还是以手机端的native播放器为主。</p>
</li>
</ul>
<p><img src="/img/hls/2.png" alt="直播整体流程"></p>
<h2 id="四、H5-录制视频"><a href="#四、H5-录制视频" class="headerlink" title="四、H5 录制视频"></a>四、H5 录制视频</h2><p>对于H5视频录制，可以使用强大的 webRTC （Web Real-Time Communication）是一个支持网页浏览器进行实时语音对话或视频对话的技术，缺点是只在 PC 的 Chrome 上支持较好，移动端支持不太理想。</p>
<h3 id="1）使用-webRTC-录制视频基本流程"><a href="#1）使用-webRTC-录制视频基本流程" class="headerlink" title="1）使用 webRTC 录制视频基本流程"></a>1）使用 webRTC 录制视频基本流程</h3><ul>
<li>1.调用 <code>window.navigator.webkitGetUserMedia()</code> 获取用户的PC摄像头视频数据。</li>
<li>2.将获取到视频流数据转换成 <code>window.webkitRTCPeerConnection</code> (一种视频流数据格式)。</li>
<li>3.利用 <code>webscoket</code> 将视频流数据传输到服务端。</li>
</ul>
<p><code>注意</code>：虽然Google一直在推WebRTC，目前已有不少成型的产品出现，但是大部分移动端的浏览器还不支持 webRTC（最新iOS 10.0也不支持），所以真正的视频录制还是要靠客户端（iOS,Android）来实现,效果会好一些。<br><img src="/img/hls/3.png" alt="WebRTC支持度"></p>
<h3 id="2）iOS原生应用调用摄像头录制视频流程"><a href="#2）iOS原生应用调用摄像头录制视频流程" class="headerlink" title="2）iOS原生应用调用摄像头录制视频流程"></a>2）iOS原生应用调用摄像头录制视频流程</h3><ul>
<li>1.音视频的采集，利用AVCaptureSession和AVCaptureDevice可以采集到原始的音视频数据流。</li>
<li>2.对视频进行H264编码，对音频进行AAC编码，在iOS中分别有已经封装好的编码库（<a href="https://github.com/kewlbear/x264-ios" target="_blank" rel="external">x264编码</a>、<a href="https://github.com/fflydev/faac-ios-build" target="_blank" rel="external">faac编码</a>、<a href="https://github.com/kewlbear/FFmpeg-iOS-build-script" target="_blank" rel="external">ffmpeg编码</a>）来实现对音视频的编码。</li>
<li>3.对编码后的音、视频数据进行组装封包。</li>
<li>4.建立RTMP连接并上推到服务端。</li>
</ul>
<p><img src="/img/hls/4.png" alt="视频流程"></p>
<h2 id="五、搭建Nginx-Rtmp直播流服务"><a href="#五、搭建Nginx-Rtmp直播流服务" class="headerlink" title="五、搭建Nginx+Rtmp直播流服务"></a>五、搭建Nginx+Rtmp直播流服务</h2><h3 id="1）安装nginx、nginx-rtmp-module"><a href="#1）安装nginx、nginx-rtmp-module" class="headerlink" title="1）安装nginx、nginx-rtmp-module"></a>1）安装nginx、nginx-rtmp-module</h3><p>① 先<code>glone nginx</code>项目到本地：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew tap homebrew/nginx</span><br></pre></td></tr></table></figure>
<p>② 执行安装<code>nginx-rtmp-module</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install nginx-full --with-rtmp-module</span><br></pre></td></tr></table></figure>
<h3 id="2）nginx-conf配置文件，配置rtmp、hls"><a href="#2）nginx-conf配置文件，配置rtmp、hls" class="headerlink" title="2）nginx.conf配置文件，配置rtmp、hls"></a>2）nginx.conf配置文件，配置rtmp、hls</h3><p>查找到nginx.conf配置文件（路径/usr/local/etc/nginx/nginx.conf），配置rtmp、hls。</p>
<p>① 在http节点之前添加 rtmp 的配置内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">rtmp &#123;</span><br><span class="line">  server &#123;</span><br><span class="line">     #监听的端口</span><br><span class="line">      listen 1935;</span><br><span class="line">      # RTMP 直播流配置</span><br><span class="line">      application rtmplive &#123;</span><br><span class="line">          live on;</span><br><span class="line">	      #为 rtmp 引擎设置最大连接数。默认为 off</span><br><span class="line">	      max_connections 1024;</span><br><span class="line">       &#125;</span><br><span class="line">	  # HLS 直播流配置</span><br><span class="line">      application hls&#123;</span><br><span class="line">          live on;</span><br><span class="line">          hls on;</span><br><span class="line">          hls_path /usr/local/var/www/hls;</span><br><span class="line">          hls_fragment 1s;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>② 在http中添加 hls的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location /hls &#123;  </span><br><span class="line">       # Serve HLS fragments  </span><br><span class="line">       types &#123;  </span><br><span class="line">           application/vnd.apple.mpegurl m3u8;  </span><br><span class="line">           video/mp2t ts;  </span><br><span class="line">       &#125;  </span><br><span class="line">       root /usr/local/var/www;  </span><br><span class="line">       #add_header Cache-Controll no-cache;</span><br><span class="line">       expires -1;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3）重启nginx服务"><a href="#3）重启nginx服务" class="headerlink" title="3）重启nginx服务"></a>3）重启nginx服务</h3><p>重启nginx服务，浏览器中输入 <a href="http://localhost:8080" target="_blank" rel="external">http://localhost:8080</a>，是否出现欢迎界面确定nginx重启成功。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure></p>
<h2 id="六、直播流转换格式、编码推流"><a href="#六、直播流转换格式、编码推流" class="headerlink" title="六、直播流转换格式、编码推流"></a>六、直播流转换格式、编码推流</h2><p>当服务器端接收到采集视频录制端传输过来的视频流时，需要对其进行解析编码，推送RTMP/HLS格式视频流至视频播放端。通常使用的常见编码库方案，如<a href="https://github.com/kewlbear/x264-ios" target="_blank" rel="external">x264编码</a>、<a href="https://github.com/fflydev/faac-ios-build" target="_blank" rel="external">faac编码</a>、<a href="https://github.com/kewlbear/FFmpeg-iOS-build-script" target="_blank" rel="external">ffmpeg编码</a>等。</p>
<p>鉴于FFmpeg集合了多种音频、视频格式编码，我们可以优先选用FFmpeg进行转换格式、编码推流。</p>
<p>1.安装ffmepg工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install ffmpeg</span><br></pre></td></tr></table></figure></p>
<p>2.推流MP4文件</p>
<p>视频文件地址：/Users/gao/Desktop/video/test.mp4<br>推流拉流地址：rtmp://localhost:1935/rtmplive/home，rtmp://localhost:1935/rtmplive/home</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//RTMP 协议流</span><br><span class="line">ffmpeg -re -i /Users/gao/Desktop/video/test.mp4 -vcodec libx264 -acodec aac -f flv rtmp://10.14.221.17:1935/rtmplive/home</span><br><span class="line"></span><br><span class="line">//HLS 协议流</span><br><span class="line">ffmpeg -re -i /Users/gao/Desktop/video/test.mp4 -vcodec libx264 -vprofile baseline -acodec aac -ar 44100 -strict -2 -ac 1 -f flv  -q 10 rtmp://10.14.221.17:1935/hls/test</span><br></pre></td></tr></table></figure>
<p><code>注意</code>： 当我们进行推流之后，可以安装<a href="http://www.pc6.com/mac/112121.html" target="_blank" rel="external">VLC</a>、ffplay（支持rtmp协议的视频播放器）本地拉流进行演示</p>
<p>3.FFmpeg推流命令</p>
<p>① 视频文件进行直播</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re -i /Users/gao/Desktop/video/test.mp4 -vcodec libx264 -vprofile baseline -acodec aac -ar 44100 -strict -2 -ac 1 -f flv  -q 10 rtmp://192.168.1.101:1935/hls/test</span><br><span class="line">ffmpeg -re -i /Users/gao/Desktop/video/test.mp4 -vcodec libx264 -vprofile baseline -acodec aac -ar 44100 -strict -2 -ac 1 -f flv  -q 10 rtmp://10.14.221.17:1935/hls/test</span><br></pre></td></tr></table></figure>
<p>② 推流摄像头＋桌面+麦克风录制进行直播</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -f avfoundation -framerate 30 -i &quot;1:0&quot; \-f avfoundation -framerate 30 -video_size 640x480 -i &quot;0&quot; \-c:v libx264 -preset ultrafast \-filter_complex &apos;overlay=main_w-overlay_w-10:main_h-overlay_h-10&apos; -acodec libmp3lame -ar 44100 -ac 1  -f flv rtmp://192.168.1.101:1935/hls/test</span><br></pre></td></tr></table></figure>
<p>更多命令，请参考：<br><a href="http://blog.csdn.net/leixiaohua1020/article/details/12029543" target="_blank" rel="external">ffmpeg处理RTMP流媒体的命令大全</a><br><a href="http://www.jianshu.com/p/d541b317f71c" target="_blank" rel="external"> FFmpeg常用推流命令</a></p>
<h2 id="七、H5-直播视频播放"><a href="#七、H5-直播视频播放" class="headerlink" title="七、H5 直播视频播放"></a>七、H5 直播视频播放</h2><p>移动端iOS和 Android 都天然支持HLS协议，做好视频采集端、视频流推流服务之后，便可以直接在H5页面配置 video 标签播放直播视频。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;video controls preload=&quot;auto&quot;  autoplay=&quot;autoplay&quot; loop=&quot;loop&quot; webkit-playsinline&gt;    </span><br><span class="line">    &lt;source src=&quot;http://10.14.221.8/hls/test.m3u8&quot; type=&quot;application/vnd.apple.mpegurl&quot; /&gt;  </span><br><span class="line">    &lt;p class=&quot;warning&quot;&gt;Your browser does not support HTML5 video.&lt;/p&gt;  </span><br><span class="line">&lt;/video&gt;</span><br></pre></td></tr></table></figure>
<p><code>ps</code>：① video标签添加<code>webkit-playsinline</code>属性是保证视频在网页中内嵌播放。<br>② 针对微信浏览器，video标签层级最高的问题，需要申请添加白名单，请参照 <a href="http://bbs.mb.qq.com/thread-1242581-1-1.html?ptlang=2052。" target="_blank" rel="external">http://bbs.mb.qq.com/thread-1242581-1-1.html?ptlang=2052。</a></p>
<h2 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h2><p>本文从视频采集上传，服务器处理视频推流，以及H5页面播放直播视频一整套流程,具体阐述了直播实现原理，实现过程中会遇到很多性能优化问题。</p>
<p>① H5 HLS 限制必须是H264+AAC编码</p>
<p>② H5 HLS 播放 卡顿问题，前端与 server 端优化处理</p>
<p>server 端需要做好分片策略，将 ts 文件放在 CDN 上，前端可尽量做到 DNS 缓存等。</p>
<p>③ H5 直播为了达到更好的实时互动，也可以采用RTMP协议，通过<code>video.js</code>实现播放。</p>
<p>参考资料：</p>
<ul>
<li><a href="https://www.zhihu.com/question/42162310" target="_blank" rel="external">如何搭建一个完整的视频直播系统？</a></li>
<li><a href="https://imququ.com/post/html5-live-player-1.html" target="_blank" rel="external">HTML5 视频直播（一）</a></li>
<li><a href="https://imququ.com/post/html5-live-player-2.html" target="_blank" rel="external">HTML5 视频直播（二）</a></li>
<li><p><a href="https://imququ.com/post/html5-live-player-3.html" target="_blank" rel="external">HTML5 视频直播（三）</a></p>
</li>
<li><p><a href="http://www.haomou.net/2014/08/04/2014_Html5_canvas_video/" target="_blank" rel="external">WebRTC相关的canvas与video</a></p>
</li>
<li><p><a href="http://www.jianshu.com/p/f198d11577f4" target="_blank" rel="external">字体平滑➕视频转canvas</a></p>
</li>
<li><p><a href="http://www.alloyteam.com/2016/05/h5-camera-literacy/" target="_blank" rel="external">H5视频直播扫盲</a></p>
</li>
<li><a href="https://segmentfault.com/a/1190000000392586" target="_blank" rel="external">使用 WebSockets 进行 HTML5 视频直播</a></li>
<li><a href="https://www.zhihu.com/question/25497090" target="_blank" rel="external">可以用WebRTC来做视频直播吗？</a></li>
<li><a href="http://blog.ucloud.cn/archives/694" target="_blank" rel="external">关于直播，所有的技术细节都在这里了（一）</a></li>
<li><a href="http://blog.ucloud.cn/archives/699" target="_blank" rel="external">关于直播，所有的技术细节都在这里了（二）</a></li>
<li><p><a href="http://blog.ucloud.cn/archives/760" target="_blank" rel="external">关于直播，所有的技术细节都在这里了（三）</a></p>
</li>
<li><p><a href="http://www.jq-school.com/Show.aspx?id=738" target="_blank" rel="external">windows+nginx+ffmpeg实现移动端html5直播m3u8</a></p>
</li>
<li><a href="https://github.com/phoboslab/jsmpeg" target="_blank" rel="external">JS解码项目jsmpeg</a></li>
</ul>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/08/29/jdc线上部署问题解决方案/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">模拟jdc部署环境，为node项目部署提供解决方案</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="H5直播起航" data-title="H5直播起航" data-url="http://pfan123.github.io/2016/09/16/H5直播起航/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 pfan
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a>
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>