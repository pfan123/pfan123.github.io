<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>pfan博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="pfan博客 新起点，新高度">
<meta property="og:type" content="website">
<meta property="og:title" content="pfan博客">
<meta property="og:url" content="http://pfan123.github.io/index.html">
<meta property="og:site_name" content="pfan博客">
<meta property="og:description" content="pfan博客 新起点，新高度">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="pfan博客">
<meta name="twitter:description" content="pfan博客 新起点，新高度">
  
    <link rel="alternative" href="/atom.xml" title="pfan博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="//litten.github.io/assets/blogImg/litten.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">pfan</a></h1>
		</hgroup>

		
		<p class="header-subtitle">新起点，新高度</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>		
					
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>About</li>
						
					</ul>
				</div>

			</div>
		


		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
				        	<li class = "article_cate_tit"> 文章分类</li>
				        	<li class = "article_cate_a"> <a  href = "/categories/技术杂谈/">技术杂谈</a>	</li>
				        	<li class = "article_cate_a"> <a href = "/categories/兴趣爱好/">兴趣爱好</a>		</li>
				        	<li class = "article_cate_a"> <a href = "/categories/日志/">日志</a></li>
				        	<li class = "article_cate_a"> <a href = "/categories/JavaScript/">JavaScript</a>	</li>
				        	<li class = "article_cate_a"> <a  href = "/categories/CSS3/">CSS3</a>	</li>
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="//github.com/pfan123" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="//weibo.com/gaolu1990/home?wvr=5" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>



				<style type="text/css">
					.article_cate_tit{
						color:#ba8f6c;
						margin-top:6px;
					}
					.article_cate_con a{
						display:block;
						font-size:12px;
						text-align:center;
						margin:4px 0;
					}
					#header .header-menu{
						line-height:21px;
					}
					.article_cate_a{
						line-height:18px !important;
					}	
					.article_cate_a a{
						font-size:12px !important;
					}				
					#container .left-col .overlay{
						height:130px;
					}
					.header-nav{
						top:160px;
					}
				</style>	
				<!-- E 新增模块-->
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/gitignore-git/" style="font-size: 10px;">.gitignore git</a> <a href="/tags/htaccess-配置二级域名-绑定子目录/" style="font-size: 10px;">.htaccess  配置二级域名  绑定子目录</a> <a href="/tags/AMD/" style="font-size: 10px;">AMD</a> <a href="/tags/CMD/" style="font-size: 10px;">CMD</a> <a href="/tags/CSS-BEM-OOCSS/" style="font-size: 10px;">CSS BEM OOCSS</a> <a href="/tags/CSS动画篇/" style="font-size: 10px;">CSS动画篇</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/ES6、module、import、export/" style="font-size: 10px;">ES6、module、import、export</a> <a href="/tags/ESLint/" style="font-size: 10px;">ESLint</a> <a href="/tags/Git，Git查看历史记录/" style="font-size: 10px;">Git，Git查看历史记录</a> <a href="/tags/H5/" style="font-size: 10px;">H5</a> <a href="/tags/H5-视频直播-video/" style="font-size: 10px;">H5 视频直播 video</a> <a href="/tags/H5全景、CSS3d、perspective/" style="font-size: 15px;">H5全景、CSS3d、perspective</a> <a href="/tags/HLS、RTMP协议/" style="font-size: 10px;">HLS、RTMP协议</a> <a href="/tags/HTML5/" style="font-size: 15px;">HTML5</a> <a href="/tags/HTML5-视频直播-video-canvas/" style="font-size: 10px;">HTML5 视频直播 video canvas</a> <a href="/tags/HTML5、localstorage、sessionStorage/" style="font-size: 10px;">HTML5、localstorage、sessionStorage</a> <a href="/tags/HTML、XML解析、dom-level、htmlparser2、xmldom、sax-js、cheerio/" style="font-size: 10px;">HTML、XML解析、dom level、htmlparser2、xmldom、sax-js、cheerio</a> <a href="/tags/HTTP-2，Nginx/" style="font-size: 10px;">HTTP/2，Nginx</a> <a href="/tags/HTTP、-node-http-proxy、-nginx、-proxy/" style="font-size: 15px;">HTTP、 node-http-proxy、 nginx、 proxy</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Linux、CentOS/" style="font-size: 10px;">Linux、CentOS</a> <a href="/tags/Linux、UNIX/" style="font-size: 10px;">Linux、UNIX</a> <a href="/tags/Linux、Unix/" style="font-size: 20px;">Linux、Unix</a> <a href="/tags/Linux、Unix、nvm、node/" style="font-size: 10px;">Linux、Unix、nvm、node</a> <a href="/tags/Mac-命令-Terminal-osx/" style="font-size: 10px;">Mac 命令 Terminal osx</a> <a href="/tags/Mac、root/" style="font-size: 10px;">Mac、root</a> <a href="/tags/Math-atan-、Math-atan2-斜率/" style="font-size: 10px;">Math.atan()、Math.atan2() 斜率</a> <a href="/tags/Mongoose参考手册-MongoDB-数据库-node/" style="font-size: 10px;">Mongoose参考手册  MongoDB  数据库 node</a> <a href="/tags/Nginx-负载均衡/" style="font-size: 10px;">Nginx  负载均衡</a> <a href="/tags/Nginx-负载均衡-node-jdc-解决方案-host/" style="font-size: 10px;">Nginx  负载均衡 node  jdc 解决方案 host</a> <a href="/tags/Nginx-Mac-Node/" style="font-size: 10px;">Nginx Mac Node</a> <a href="/tags/Nginx-MySQL-PHP-FPM-Mac-OS/" style="font-size: 10px;">Nginx MySQL PHP-FPM Mac OS</a> <a href="/tags/Nodejs学习实践-nodejs-ES6/" style="font-size: 10px;">Nodejs学习实践 nodejs  ES6</a> <a href="/tags/PreloadJS-EaselJS-TweenJS-SoundJS/" style="font-size: 10px;">PreloadJS EaselJS TweenJS SoundJS</a> <a href="/tags/SVG-Sprites-Symbols/" style="font-size: 10px;">SVG Sprites Symbols</a> <a href="/tags/SVG-icon、-导出优化/" style="font-size: 10px;">SVG icon、 导出优化</a> <a href="/tags/SVG、dataURI、base64/" style="font-size: 10px;">SVG、dataURI、base64</a> <a href="/tags/UMD/" style="font-size: 10px;">UMD</a> <a href="/tags/Vim-vi/" style="font-size: 10px;">Vim vi</a> <a href="/tags/Webhook，git/" style="font-size: 10px;">Webhook，git</a> <a href="/tags/Webhook，git，-Git-Hooks/" style="font-size: 10px;">Webhook，git， Git Hooks</a> <a href="/tags/createJS/" style="font-size: 10px;">createJS</a> <a href="/tags/css-modules-scope-模块化/" style="font-size: 10px;">css modules  scope  模块化</a> <a href="/tags/device-width-window-screen-width-区分ip6与ip6plus/" style="font-size: 10px;">device-width window.screen.width 区分ip6与ip6plus</a> <a href="/tags/deviceorientation、orientationchange-重力感应/" style="font-size: 10px;">deviceorientation、orientationchange 重力感应</a> <a href="/tags/deviceorientation、orientationchange-重力感应-CSS3D/" style="font-size: 10px;">deviceorientation、orientationchange 重力感应 CSS3D</a> <a href="/tags/exif，oritation，input，file/" style="font-size: 10px;">exif，oritation，input，file</a> <a href="/tags/express/" style="font-size: 10px;">express</a> <a href="/tags/fiddler/" style="font-size: 10px;">fiddler</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/hexo初始/" style="font-size: 10px;">hexo初始</a> <a href="/tags/hexo相关问题/" style="font-size: 10px;">hexo相关问题</a> <a href="/tags/history-pushState-history-replaceState/" style="font-size: 10px;">history.pushState(), history.replaceState()</a> <a href="/tags/howler-js、-video-js/" style="font-size: 10px;">howler.js、 video.js</a> <a href="/tags/insertAdjacentHTML方法/" style="font-size: 10px;">insertAdjacentHTML方法</a> <a href="/tags/insertAdjacentText方法/" style="font-size: 10px;">insertAdjacentText方法</a> <a href="/tags/javascript、canvas、toDataURL/" style="font-size: 10px;">javascript、canvas、toDataURL()</a> <a href="/tags/letsencrypt、HTTPS、SSL、TSL/" style="font-size: 10px;">letsencrypt、HTTPS、SSL、TSL</a> <a href="/tags/mac-iphone-铃声/" style="font-size: 10px;">mac iphone 铃声</a> <a href="/tags/node-版本管理-nvm-n/" style="font-size: 10px;">node 版本管理  nvm  n</a> <a href="/tags/node-读写excel-JS-XLSX-分析excel写入/" style="font-size: 10px;">node 读写excel JS-XLSX 分析excel写入</a> <a href="/tags/pm2学习实践-nodejs-pm2/" style="font-size: 10px;">pm2学习实践 nodejs pm2</a> <a href="/tags/react-flux-redux-ECMAScript6-Vue-Angular-Angular2-0-NuclearJS/" style="font-size: 10px;">react flux redux ECMAScript6 Vue Angular Angular2.0 NuclearJS</a> <a href="/tags/ssh常用命令-SSH/" style="font-size: 10px;">ssh常用命令  SSH</a> <a href="/tags/ssh，Nginx/" style="font-size: 10px;">ssh，Nginx</a> <a href="/tags/svg、path、circle、rect、ellipse、polygon、polyline、line/" style="font-size: 10px;">svg、path、circle、rect、ellipse、polygon、polyline、line</a> <a href="/tags/video-canvas/" style="font-size: 10px;">video canvas</a> <a href="/tags/vue-router-vue/" style="font-size: 10px;">vue-router, vue</a> <a href="/tags/webp/" style="font-size: 10px;">webp</a> <a href="/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/tags/webpack、vue、react、webpack-dev-server/" style="font-size: 10px;">webpack、vue、react、webpack-dev-server</a> <a href="/tags/三角学、弧度、角度/" style="font-size: 10px;">三角学、弧度、角度</a> <a href="/tags/买房前必备知识-house-home/" style="font-size: 10px;">买房前必备知识  house home</a> <a href="/tags/买车前必备知识-car/" style="font-size: 10px;">买车前必备知识  car</a> <a href="/tags/京东购物H5活动CP重构规范/" style="font-size: 10px;">京东购物H5活动CP重构规范</a> <a href="/tags/优化JavaScript的执行效率/" style="font-size: 10px;">优化JavaScript的执行效率</a> <a href="/tags/前端性能优化/" style="font-size: 10px;">前端性能优化</a> <a href="/tags/吉他/" style="font-size: 10px;">吉他</a> <a href="/tags/吉他知识/" style="font-size: 10px;">吉他知识</a> <a href="/tags/学吉他知识集锦/" style="font-size: 10px;">学吉他知识集锦</a> <a href="/tags/搬瓦工，Shadowsocks/" style="font-size: 10px;">搬瓦工，Shadowsocks</a> <a href="/tags/旅游-帝都畅游-相约北京/" style="font-size: 10px;">旅游 帝都畅游 相约北京</a> <a href="/tags/模块的写法/" style="font-size: 10px;">模块的写法</a> <a href="/tags/腾讯地图/" style="font-size: 10px;">腾讯地图</a> <a href="/tags/运营规范/" style="font-size: 10px;">运营规范</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="//www.cnblogs.com/pingfan1990/">博客园博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://case.pfan123.com/">pfan展示平台</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="//docs.pfan123.com/">pfan前端开发导航平台</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">因上努力，果上随缘</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">pfan</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="//litten.github.io/assets/blogImg/litten.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">pfan</h1>
			</hgroup>
			
			<p class="header-subtitle">新起点，新高度</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="//github.com/pfan123" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="//weibo.com/gaolu1990/home?wvr=5" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-腾讯地图api使用指南" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/24/腾讯地图api使用指南/" class="article-date">
  	<time datetime="2017-04-24T02:00:21.000Z" itemprop="datePublished">2017-04-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/24/腾讯地图api使用指南/">腾讯地图api使用指南</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="腾讯地图产品"><a href="#腾讯地图产品" class="headerlink" title="腾讯地图产品"></a>腾讯地图产品</h2><table>
<thead>
<tr>
<th>产品</th>
<th>产品描述</th>
<th>使用限制</th>
</tr>
</thead>
<tbody>
<tr>
<td>地图组件（H5）</td>
<td>手机浏览器专用，完整应用功能无需开发，极简接入，包括： H5定位组件（大幅提升手机浏览器定位效果）、地点标注、路线规划等功能 <br> <a href="http://lbs.qq.com/tool/component-marker.html" target="_blank" rel="external">查看文档&gt;&gt; </a></td>
<td>无限制</td>
</tr>
<tr>
<td>地图JavascriptAPI</td>
<td>用于浏览器端地图显示与应用，手机 与 PC浏览器全兼容 <br> <a href="http://lbs.qq.com/tool/component-marker.html" target="_blank" rel="external">查看文档&gt;&gt; </a></td>
<td>无限制</td>
</tr>
<tr>
<td>定位SDK</td>
<td>用于手机端APP定位终端位置： <br> <a href="http://lbs.qq.com/geo/index.html" target="_blank" rel="external">Android定位SDK</a>  <a href="http://lbs.qq.com/iosgeo/index.html" target="_blank" rel="external">iOS定位SDK</a></td>
<td>无限制</td>
</tr>
<tr>
<td>地图SDK</td>
<td>用于手机端APP嵌入地图显示与应用： <br>  <a href="http://lbs.qq.com/android_v1/index.html" target="_blank" rel="external">Android地图SDK</a>  <a href="http://lbs.qq.com/ios_v1/index.html" target="_blank" rel="external">iOS地图SDK</a></td>
<td>无限制</td>
</tr>
<tr>
<td>WebServiceAPI</td>
<td>http数据接口，适用于服务端或任意支持http协议的环境, 提供 地址解析、地点搜索、行政区划、路线规划、距离计算等功能, 服务通过输入参数，计算并返回json结构的结果，如需在地图中展现，需要结合SDK或JsAPI一起使用 <br> <a href="http://lbs.qq.com/webservice_v1/index.html" target="_blank" rel="external">查看文档&gt;&gt; </a></td>
<td>日限制：1万次/key/接口 <br> 并发限制：5次/秒/key/接口  <br> 如需更大配额可进行申请：<br> <a href="http://lbs.qq.com/webservice_v1/index.html" target="_blank" rel="external">点击查看详情</a></td>
</tr>
</tbody>
</table>
<h2 id="关于-JavaScript-API"><a href="#关于-JavaScript-API" class="headerlink" title="关于 JavaScript API"></a>关于 JavaScript API</h2><p>JavaScript API V2可用于在网站中加入交互性强的街景、地图，能很好地支持PC及手机设备，身材小巧，动画效果顺滑流畅，动感十足，提供地图操作、标注、地点搜索、出行规划、地址解析、街景等接口，功能丰富，并免费开放各种附加工具库。JavaScript API V2是免费服务，任何提供免费访问的网站都可以调用，请参见使用条款。</p>
<p>JavaScript API上手还是比较简单的，资料这块比较齐全：</p>
<p>主要包含大类：</p>
<blockquote>
<p>地图<br>控件<br>覆盖物<br>服务<br>地图类型<br>街景<br>事件<br>基础类<br>MVC<br>Geometry Library<br>Place Library<br>Drawing Library<br>Convertor Library</p>
</blockquote>
<p>使用指南：<br>开发指南： <a href="//lbs.qq.com/javascript_v2/index.html">http://lbs.qq.com/javascript_v2/index.html</a><br>参考手册： <a href="//lbs.qq.com/javascript_v2/doc/index.html">http://lbs.qq.com/javascript_v2/doc/index.html</a><br>示例demo： <a href="//lbs.qq.com/javascript_v2/demo.html">http://lbs.qq.com/javascript_v2/demo.html</a><br>H5定位组件： <a href="//lbs.qq.com/tool/component-marker.html">http://lbs.qq.com/tool/component-marker.html</a></p>
<p>说说几个常用的例子：<br>1.禁止所有的默认控件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var map = new qq.maps.Map(document.getElementById(&quot;map-canvas&quot;), &#123;</span><br><span class="line">    disableDefaultUI: true    //禁止所有控件</span><br><span class="line">    //或</span><br><span class="line">    panControl: true,         //平移控件的初始启用/停用状态     </span><br><span class="line">    zoomControl: false,       //缩放控件的初始启用/停用状态</span><br><span class="line">    scaleControl: true        //滚动标尺控件的初始启用/停用状态    </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>2.拖动地图显示地图中心坐标信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var map = new qq.maps.Map(document.querySelector(&quot;.homev2_map_img&quot;), &#123;</span><br><span class="line">    // 地图的中心地理坐标。</span><br><span class="line">    center: new qq.maps.LatLng(lat, lng),</span><br><span class="line">    zoom: 10,  //取值1～15</span><br><span class="line">    disableDefaultUI: true,</span><br><span class="line">    mapTypeId: qq.maps.MapTypeId.ROADMAP</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">//地图移动获取中心点坐标</span><br><span class="line">qq.maps.event.addListener(map, &apos;center_changed&apos;, function() &#123;</span><br><span class="line">    console.log(&quot;导出中心点&quot;, map.getCenter())</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>3.添加Marker覆盖物标签对齐居中显示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">//创建Marker覆盖物</span><br><span class="line">createMarker (map, lat, lng, callback, txt = &quot;塞纳春天大家好&quot;) &#123;</span><br><span class="line">  //http://lbs.qq.com/javascript_v2/doc/markeroptions.html 定义覆盖物图片</span><br><span class="line">  //http://lbs.qq.com/javascript_v2/doc/markerimage.html</span><br><span class="line">  let center = new qq.maps.LatLng(lat, lng)</span><br><span class="line">  let anchor = new qq.maps.Point(0, 58/4),</span><br><span class="line">        size = new qq.maps.Size(52, 58),</span><br><span class="line">        origin = new qq.maps.Point(0, 0),</span><br><span class="line">        scaleSize = new qq.maps.Size(52/2, 58/2)</span><br><span class="line">  let markerIcon = new qq.maps.MarkerImage(</span><br><span class="line">    &quot;//wq.360buyimg.com/fd/h5/wx/home_v2/images/homev2_map_icon_b00aa33e.png&quot;,</span><br><span class="line">    size, </span><br><span class="line">    origin,</span><br><span class="line">    anchor,</span><br><span class="line">    scaleSize</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  let marker = new qq.maps.Marker(&#123;</span><br><span class="line">      position: center,</span><br><span class="line">      //animation:qq.maps.MarkerAnimation.DROP, 动画类型，需设置阴影，如果没则出现关闭叉</span><br><span class="line">      map: map</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  marker.setIcon(markerIcon)     </span><br><span class="line">  if(callback)&#123;</span><br><span class="line">  	 //绑定事件</span><br><span class="line">     qq.maps.event.addListener(marker, &apos;click&apos;, function() &#123;</span><br><span class="line">        callback &amp;&amp; callback()</span><br><span class="line">    &#125;)            </span><br><span class="line">  &#125;</span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">  this.createMarkerLable(map, lat, lng, txt, function()&#123;</span><br><span class="line">    callback &amp;&amp; callback()</span><br><span class="line">  &#125;) </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//创建标签，通过样式控制居中</span><br><span class="line">createMarkerLable (map, lat, lng, txt, callback) &#123;</span><br><span class="line">  //http://lbs.qq.com/javascript_v2/doc/label.html</span><br><span class="line">  //http://lbs.qq.com/javascript_v2/doc/labeloptions.html文字设置</span><br><span class="line">  let center = new qq.maps.LatLng(lat, lng)</span><br><span class="line"></span><br><span class="line">  let markerLabel = new qq.maps.Label(&#123;</span><br><span class="line">      position: center,</span><br><span class="line">      map: map,</span><br><span class="line">      content: txt,</span><br><span class="line">      offset: new qq.maps.Size(24/2, -34),</span><br><span class="line">      zIndex: 10,</span><br><span class="line">      style: &#123;</span><br><span class="line">        color: &quot;#fff&quot;,</span><br><span class="line">        backgroundColor: &quot;rgba(165,103,65,.85)&quot;,</span><br><span class="line">        // left: &quot;50%&quot;,</span><br><span class="line">        webkitTransform: &quot;translateX(-50%)&quot;,</span><br><span class="line">        height: &quot;15px&quot;,</span><br><span class="line">        textAlign: &quot;center&quot;,</span><br><span class="line">        fontSize: &quot;10px&quot;,</span><br><span class="line">        lineHeight: &quot;15px&quot;,</span><br><span class="line">        padding: &quot;0 4px&quot;,</span><br><span class="line">        border: &quot;0&quot;,</span><br><span class="line">        webkitBorderRadius: &quot;2px&quot;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  //绑定事件</span><br><span class="line">  qq.maps.event.addListener(markerLabel, &apos;click&apos;, function() &#123;</span><br><span class="line">      callback &amp;&amp; callback()</span><br><span class="line">  &#125;)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>ps: pc端没有定位传感器，无法做到准确定位，定位实现通常是通过ip分析转换，腾讯地图默认没有传感器不会做处理。</p>
</blockquote>
<p>参考资料：</p>
<p><a href="http://lbs.qq.com/javascript_v2/index.html" target="_blank" rel="external">开发指南</a><br><a href="http://lbs.qq.com/javascript_v2/doc/index.html" target="_blank" rel="external">参考手册</a><br><a href="http://lbs.qq.com/javascript_v2/demo.html" target="_blank" rel="external">示例demo</a><br><a href="http://lbs.qq.com/tool/component-marker.html" target="_blank" rel="external">H5定位组件</a><br><a href="https://www.zhihu.com/question/22732084" target="_blank" rel="external">为何在PC浏览器地图上，不制作定位当前位置的功能？</a><br><a href="https://www.zhihu.com/question/39941895" target="_blank" rel="external">网页版百度地图是如何定位的？</a></p>

      
    </div>

    <!-- S 打赏模块 -->
    <div class="pfan_payment" style="max-width: 500px;margin: 0 auto">
        <img src="http://img.pfan123.com/payment.png" alt="" style="width: 100%;height: 10%;">
    </div>
    <!-- E 打赏模块 -->


    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/腾讯地图/">腾讯地图</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
    
</article>











  
    <article id="post-history对象" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/18/history对象/" class="article-date">
  	<time datetime="2017-04-18T02:00:21.000Z" itemprop="datePublished">2017-04-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/18/history对象/">history对象--转载</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>浏览器窗口有一个 <code>history</code> 对象，用来保存浏览历史。</p>
<p>如果当前窗口先后访问了三个网址，那么 <code>history</code> 对象就包括三项，<code>history.length</code> 属性等于3。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history.length // 3</span><br></pre></td></tr></table></figure>
<p><code>history</code> 对象提供了一系列方法，允许在浏览历史之间移动。</p>
<blockquote>
<p>back()：移动到上一个访问页面，等同于浏览器的后退键。<br>forward()：移动到下一个访问页面，等同于浏览器的前进键。<br>go()：接受一个整数作为参数，移动到该整数指定的页面，比如go(1)相当于forward()，go(-1)相当于back()。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">history.back();</span><br><span class="line">history.forward();</span><br><span class="line">history.go(-2);</span><br></pre></td></tr></table></figure>
<p>如果移动的位置超出了访问历史的边界，以上三个方法并不报错，而是默默的失败。<br><code>history.go(0)</code>相当于刷新当前页面。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history.go(0);</span><br></pre></td></tr></table></figure></p>
<p>常见的“返回上一页”链接，代码如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">document.getElementById(&apos;backLink&apos;).onclick = function () &#123;</span><br><span class="line">  window.history.back();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意，返回上一页时，页面通常是从浏览器缓存之中加载，而不是重新要求服务器发送新的网页。</p>
<h2 id="二、history-pushState"><a href="#二、history-pushState" class="headerlink" title="二、history.pushState()"></a>二、history.pushState()</h2><p>HTML5为 <code>history</code> 对象添加了两个新方法，<code>history.pushState()</code>和<code>history.replaceState()</code>，用来在浏览历史中添加和修改记录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (!!(window.history &amp;&amp; history.pushState))&#123;</span><br><span class="line">  // 支持History API</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  // 不支持</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码可以用来检查，当前浏览器是否支持History API。如果不支持的话，可以考虑使用Polyfill库 <a href="https://github.com/browserstate/history.js/" target="_blank" rel="external">History.js</a>。</p>
<p><code>history.pushState</code> 方法接受三个参数，依次为：</p>
<blockquote>
<p>state：一个与指定网址相关的状态对象，popstate事件触发时，该对象会传入回调函数。如果不需要这个对象，此处可以填null。<br>title：新页面的标题，但是所有浏览器目前都忽略这个值，因此这里可以填null。<br>url：新的网址，必须与当前页面处在同一个域。浏览器的地址栏将显示这个网址。</p>
</blockquote>
<p>假定当前网址是 <code>example.com/1.html</code>，我们使用 <code>pushState</code> 方法在浏览记录（<code>history</code>对象）中添加一个新记录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var stateObj = &#123; foo: &apos;bar&apos; &#125;;</span><br><span class="line">history.pushState(stateObj, &apos;page 2&apos;, &apos;2.html&apos;);</span><br></pre></td></tr></table></figure>
<p>添加上面这个新记录后，浏览器地址栏立刻显示 <code>example.com/2.html</code>，但并不会跳转到 <code>2.html</code>，甚至也不会检查 <code>2.html</code> 是否存在，它只是成为浏览历史中的最新记录。假定这时你访问了 <code>google.com</code>，然后点击了倒退按钮，页面的url将显示 <code>2.html</code>，但是内容还是原来的 <code>1.html</code>。你再点击一次倒退按钮，url将显示 <code>1.html</code>，内容不变。</p>
<p>总之，<code>pushState</code> 方法不会触发页面刷新，只是导致 <code>history</code> 对象发生变化，地址栏会有反应。</p>
<p>如果 <code>pushState</code> 的url参数，设置了一个新的锚点值（即<code>hash</code>），并不会触发 <code>hashchange</code> 事件。如果设置了一个跨域网址，则会报错。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history.pushState(null, null, &apos;https://twitter.com/hello&apos;);</span><br></pre></td></tr></table></figure></p>
<p>上面代码中，<code>pushState</code> 想要插入一个跨域的网址，导致报错。这样设计的目的是，防止恶意代码让用户以为他们是在另一个网站上。</p>
<h2 id="三、history-replaceState"><a href="#三、history-replaceState" class="headerlink" title="三、history.replaceState()"></a>三、history.replaceState()</h2><p><code>history.replaceState</code> 方法的参数与 <code>pushState</code> 方法一模一样，区别是它修改浏览历史中当前纪录。</p>
<p>假定当前网页是 <code>example.com/example.html</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">history.pushState(&#123;page: 1&#125;, &apos;title 1&apos;, &apos;?page=1&apos;);</span><br><span class="line">history.pushState(&#123;page: 2&#125;, &apos;title 2&apos;, &apos;?page=2&apos;);</span><br><span class="line">history.replaceState(&#123;page: 3&#125;, &apos;title 3&apos;, &apos;?page=3&apos;);</span><br><span class="line"></span><br><span class="line">history.back()</span><br><span class="line">// url显示为//example.com/example.html?page=1</span><br><span class="line"></span><br><span class="line">history.back()</span><br><span class="line">// url显示为//example.com/example.html</span><br><span class="line"></span><br><span class="line">history.go(2)</span><br><span class="line">// url显示为//example.com/example.html?page=3</span><br></pre></td></tr></table></figure>
<h2 id="四、history-state属性"><a href="#四、history-state属性" class="headerlink" title="四、history.state属性"></a>四、history.state属性</h2><p><code>history.state</code> 属性返回当前页面的 <code>state</code> 对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">history.pushState(&#123;page: 1&#125;, &apos;title 1&apos;, &apos;?page=1&apos;);</span><br><span class="line"></span><br><span class="line">history.state</span><br><span class="line">// &#123; page: 1 &#125;</span><br></pre></td></tr></table></figure>
<h2 id="五、popstate事件"><a href="#五、popstate事件" class="headerlink" title="五、popstate事件"></a>五、popstate事件</h2><p>每当同一个文档的浏览历史（即 <code>history</code> 对象）出现变化时，就会触发 <code>popstate</code> 事件。</p>
<p>需要注意的是，仅仅调用 <code>pushState</code> 方法或 <code>replaceState</code> 方法 ，并不会触发该事件，只有用户点击浏览器倒退按钮和前进按钮，或者使用JavaScript调用 <code>back</code>、<code>forward</code>、<code>go</code>方法时才会触发。另外，该事件只针对同一个文档，如果浏览历史的切换，导致加载不同的文档，该事件也不会触发。</p>
<p>使用的时候，可以为 <code>popstate</code>事件指定回调函数。这个回调函数的参数是一个 <code>event</code> 事件对象，它的 <code>state</code> 属性指向 <code>pushState</code> 和 <code>replaceState</code> 方法为当前URL所提供的状态对象（即这两个方法的第一个参数）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">window.onpopstate = function (event) &#123;</span><br><span class="line">  console.log(&apos;location: &apos; + document.location);</span><br><span class="line">  console.log(&apos;state: &apos; + JSON.stringify(event.state));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 或者</span><br><span class="line"></span><br><span class="line">window.addEventListener(&apos;popstate&apos;, function(event) &#123;</span><br><span class="line">  console.log(&apos;location: &apos; + document.location);</span><br><span class="line">  console.log(&apos;state: &apos; + JSON.stringify(event.state));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上面代码中的 <code>event.state</code>，就是通过 <code>pushState</code> 和 <code>replaceState</code> 方法，为当前URL绑定的 <code>state</code> 对象。</p>
<p>这个 <code>state</code> 对象也可以直接通过 <code>history</code> 对象读取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var currentState = history.state;</span><br></pre></td></tr></table></figure>
<p>注意，页面第一次加载的时候，在 <code>load</code> 事件发生后，Chrome和Safari浏览器（Webkit核心）会触发 <code>popstate</code> 事件，而Firefox和IE浏览器不会。</p>
<h2 id="六、URLSearchParams-API"><a href="#六、URLSearchParams-API" class="headerlink" title="六、URLSearchParams API"></a>六、URLSearchParams API</h2><p>URLSearchParams API用于处理URL之中的查询字符串，即问号之后的部分。没有部署这个API的浏览器，可以用 <a href="https://github.com/WebReflection/url-search-params" target="_blank" rel="external">url-search-params</a> 这个垫片库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var paramsString = &apos;q=URLUtils.searchParams&amp;topic=api&apos;;</span><br><span class="line">var searchParams = new URLSearchParams(paramsString);</span><br></pre></td></tr></table></figure>
<p>URLSearchParams有以下方法，用来操作某个参数。</p>
<blockquote>
<p>has()：返回一个布尔值，表示是否具有某个参数<br>get()：返回指定参数的第一个值<br>getAll()：返回一个数组，成员是指定参数的所有值<br>set()：设置指定参数<br>delete()：删除指定参数<br>append()：在查询字符串之中，追加一个键值对<br>toString()：返回整个查询字符串</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">var paramsString = &apos;q=URLUtils.searchParams&amp;topic=api&apos;;</span><br><span class="line">var searchParams = new URLSearchParams(paramsString);</span><br><span class="line"></span><br><span class="line">searchParams.has(&apos;topic&apos;) // true</span><br><span class="line">searchParams.get(&apos;topic&apos;) // &quot;api&quot;</span><br><span class="line">searchParams.getAll(&apos;topic&apos;) // [&quot;api&quot;]</span><br><span class="line"></span><br><span class="line">searchParams.get(&apos;foo&apos;) // null，注意Firefox返回空字符串</span><br><span class="line">searchParams.set(&apos;foo&apos;, 2);</span><br><span class="line">searchParams.get(&apos;foo&apos;) // 2</span><br><span class="line"></span><br><span class="line">searchParams.append(&apos;topic&apos;, &apos;webdev&apos;);</span><br><span class="line">searchParams.toString() // &quot;q=URLUtils.searchParams&amp;topic=api&amp;foo=2&amp;topic=webdev&quot;</span><br><span class="line"></span><br><span class="line">searchParams.append(&apos;foo&apos;, 3);</span><br><span class="line">searchParams.getAll(&apos;foo&apos;) // [2, 3]</span><br><span class="line"></span><br><span class="line">searchParams.delete(&apos;topic&apos;);</span><br><span class="line">searchParams.toString() // &quot;q=URLUtils.searchParams&amp;foo=2&amp;foo=3&quot;</span><br></pre></td></tr></table></figure>
<p>URLSearchParams还有三个方法，用来遍历所有参数。</p>
<blockquote>
<p>keys()：遍历所有参数名<br>values()：遍历所有参数值<br>entries()：遍历所有参数的键值对</p>
</blockquote>
<p>上面三个方法返回的都是 <code>Iterator</code> 对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">var searchParams = new URLSearchParams(&apos;key1=value1&amp;key2=value2&apos;);</span><br><span class="line"></span><br><span class="line">for (var key of searchParams.keys()) &#123;</span><br><span class="line">  console.log(key);</span><br><span class="line">&#125;</span><br><span class="line">// key1</span><br><span class="line">// key2</span><br><span class="line"></span><br><span class="line">for (var value of searchParams.values()) &#123;</span><br><span class="line">  console.log(value);</span><br><span class="line">&#125;</span><br><span class="line">// value1</span><br><span class="line">// value2</span><br><span class="line"></span><br><span class="line">for (var pair of searchParams.entries()) &#123;</span><br><span class="line">  console.log(pair[0]+ &apos;, &apos;+ pair[1]);</span><br><span class="line">&#125;</span><br><span class="line">// key1, value1</span><br><span class="line">// key2, value2</span><br></pre></td></tr></table></figure>
<p>在Chrome浏览器之中，<code>URLSearchParams</code> 实例本身就是 <code>Iterator</code> 对象，与 <code>entries</code> 方法返回值相同。所以，可以写成下面的样子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (var p of searchParams) &#123;</span><br><span class="line">  console.log(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是一个替换当前URL的例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// URL: https://example.com?version=1.0</span><br><span class="line">var params = new URLSearchParams(location.search.slice(1));</span><br><span class="line">params.set(&apos;version&apos;, 2.0);</span><br><span class="line"></span><br><span class="line">window.history.replaceState(&#123;&#125;, &apos;&apos;, `$&#123;location.pathname&#125;?$&#123;params&#125;`);</span><br><span class="line">// URL: https://example.com?version=2.0</span><br></pre></td></tr></table></figure>
<p><code>URLSearchParams</code>实例可以当作POST数据发送，所有数据都会URL编码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">let params = new URLSearchParams();</span><br><span class="line">params.append(&apos;api_key&apos;, &apos;1234567890&apos;);</span><br><span class="line"></span><br><span class="line">fetch(&apos;https://example.com/api&apos;, &#123;</span><br><span class="line">  method: &apos;POST&apos;,</span><br><span class="line">  body: params</span><br><span class="line">&#125;).then(...)</span><br></pre></td></tr></table></figure>
<p>DOM的 <code>a</code> 元素节点的 <code>searchParams</code> 属性，就是一个 <code>URLSearchParams</code> 实例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var a = document.createElement(&apos;a&apos;);</span><br><span class="line">a.href = &apos;https://example.com?filter=api&apos;;</span><br><span class="line">a.searchParams.get(&apos;filter&apos;) // &quot;api&quot;</span><br></pre></td></tr></table></figure>
<p><code>URLSearchParams</code> 还可以与 <code>URL</code> 接口结合使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var url = new URL(location);</span><br><span class="line">var foo = url.searchParams.get(&apos;foo&apos;) || &apos;somedefault&apos;;</span><br></pre></td></tr></table></figure>
<p>参考资料：</p>
<p><a href="//javascript.ruanyifeng.com/bom/history.html">history对象</a><br><a href="https://developer.mozilla.org/zh-CN/docs/DOM/Manipulating_the_browser_history" target="_blank" rel="external">操纵浏览器的历史记录</a><br><a href="https://www.zhihu.com/question/27806318" target="_blank" rel="external">hashchange和popstate的用法区别</a><br><a href="https://segmentfault.com/a/1190000004574465" target="_blank" rel="external">历史记录API中hashchange与popstate的比较</a></p>

      
    </div>

    <!-- S 打赏模块 -->
    <div class="pfan_payment" style="max-width: 500px;margin: 0 auto">
        <img src="http://img.pfan123.com/payment.png" alt="" style="width: 100%;height: 10%;">
    </div>
    <!-- E 打赏模块 -->


    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/history-pushState-history-replaceState/">history.pushState(), history.replaceState()</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
    
</article>











  
    <article id="post-学习weppack-基础篇" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/17/学习weppack-基础篇/" class="article-date">
  	<time datetime="2017-04-17T02:00:21.000Z" itemprop="datePublished">2017-04-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/17/学习weppack-基础篇/">模块化工具webpack基础篇</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="https://webpack.js.org/" target="_blank" rel="external">webpack</a>是目前前端开发必不可少的一款模块加载器兼构建工具，它能极其方便的处理各种资源的打包和使用， 让前端开发获得与后端开发几乎一致的体验。</p>
<h2 id="Webpack是什么"><a href="#Webpack是什么" class="headerlink" title="Webpack是什么"></a>Webpack是什么</h2><p>CommonJS 和 AMD 是用于 JavaScript 模块管理的两大规范，前者定义的是模块的同步加载，主要用于NodeJS；而后者则是异步加载，通过 requirejs 等工具适用于前端。随着 npm 成为主流的 JavaScript 组件发布平台，越来越多的前端项目也依赖于 npm 上的项目，或者自身就会发布到 npm 平台。因此，让前端项目更方便的使用 npm 上的资源成为一大需求。</p>
<p>web开发中常用到的静态资源主要有JavaScript、CSS、图片、Jade等文件，webpack中将静态资源文件称之为模块。webpack是一个module bundler(模块打包工具)，其可以兼容多种js书写规范，且可以处理模块间的依赖关系，具有更强大的js模块化的功能。Webpack对它们进行统一的管理以及打包发布，其官方主页用下面这张图来说明Webpack的作用：</p>
<p><img src="http://img.pfan123.com/webpack/webpack1_1.png" alt="webpack"></p>
<h2 id="Webpack的核心原理"><a href="#Webpack的核心原理" class="headerlink" title="Webpack的核心原理"></a>Webpack的核心原理</h2><p>Webpack的两个最核心的原理分别是：</p>
<p><strong> 1.一切皆模块 </strong><br>正如js文件可以是一个“模块（module）”一样，其他的（如css、image或html）文件也可视作模 块。因此，你可以require(‘myJSfile.js’)亦可以require(‘myCSSfile.css’)。这意味着我们可以将事物（业务）分割成更小的易于管理的片段，从而达到重复利用等的目的。</p>
<p><strong> 2.按需加载 </strong><br>传统的模块打包工具（module bundlers）最终将所有的模块编译生成一个庞大的bundle.js文件。但是在真实的app里边，“bundle.js”文件可能有10M到15M之大可能会导致应用一直处于加载中状态。因此Webpack使用许多特性来分割代码然后生成多个“bundle”文件，而且异步加载部分代码以实现按需加载。</p>
<h2 id="Webpack特点"><a href="#Webpack特点" class="headerlink" title="Webpack特点"></a>Webpack特点</h2><blockquote>
<ol>
<li>对 CommonJS 、 AMD 、ES6的语法做了兼容</li>
<li>对js、css、图片等资源文件都支持打包</li>
<li>串联式模块加载器以及插件机制，让其具有更好的灵活性和扩展性，例如提供对CoffeeScript、ES6的支持</li>
<li>有独立的配置文件webpack.config.js</li>
<li>可以将代码切割成不同的chunk，实现按需加载，降低了初始化时间</li>
<li>支持 SourceUrls 和 SourceMaps，易于调试</li>
<li>具有强大的Plugin接口，大多是内部插件，使用起来比较灵活</li>
<li>webpack 使用异步 IO 并具有多级缓存。这使得 webpack 很快且在增量编译上更加快</li>
</ol>
</blockquote>
<h2 id="Webpack安装和配置"><a href="#Webpack安装和配置" class="headerlink" title="Webpack安装和配置"></a>Webpack安装和配置</h2><p><strong> 安装 </strong> </p>
<p>webpack 可以作为全局的 npm 模块安装，也可以在当前项目中安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install -g webpack  //全局安装</span><br><span class="line">npm install --save-dev webpack   //局部安装</span><br></pre></td></tr></table></figure>
<p>对于全局安装的webpack，直接执行此命令会默认使用当前目录的webpack.config.js作为配置文件。如果要指定另外的配置文件，可以执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpack —config webpack.custom.config.js</span><br></pre></td></tr></table></figure>
<p><strong> 配置 </strong> </p>
<p>每个项目下都必须配置有一个 webpack.config.js ，它的作用如同常规的 gulpfile.js/Gruntfile.js ，就是一个配置项，告诉 webpack 它需要做什么。</p>
<p>webpack.config.js文件通常放在项目的根目录中，它本身也是一个标准的Commonjs规范的模块。在导出的配置对象中有几个关键的参数：</p>
<p><strong> entry </strong></p>
<p>entry 参数定义了打包后的入口文件，可以是个字符串或数组或者是对象；如果是数组，数组中的所有文件会打包生成一个filename文件；如果是对象，可以将不同的文件构建成不同的文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    entry: &#123;</span><br><span class="line">        index: &quot;./page1／index.js&quot;,  </span><br><span class="line">        //支持数组形式，将加载数组中的所有模块，但以最后一个模块作为输出</span><br><span class="line">        login: [&quot;./entry1/login.js&quot;, &quot;./entry2/register.js&quot;]</span><br><span class="line">    &#125;,</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: &quot;dist/js/page&quot;,</span><br><span class="line">        publicPath: &quot;/output/&quot;,</span><br><span class="line">        filename: &quot;[chunk].[name].bundle.js&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ps: chunk：被entry所依赖的额外的代码块，同样可以包含一个或者多个文件</p>
</blockquote>
<p>该段代码最终会生成一个 page1.bundle.js 和 page2.bundle.js，并存放到 ./dist/js/page 文件夹下</p>
<p><strong> output </strong> </p>
<p>output参数是个对象，定义了输出文件的位置及名字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">output: &#123;</span><br><span class="line">        path: path.resolve(__dirname, &quot;build&quot;), //打包输出路径，建议使用绝对路径，使用webpack-dev-server, 可将该目录设置为为虚拟web服务器的根目录</span><br><span class="line">        </span><br><span class="line">        // 配置文件在html中引用的根路径，改变静态资源引入的相对路径</span><br><span class="line">        publicPath: &quot;/assets/&quot;,</span><br><span class="line">        //publicPath: &quot;http://cdn.com/assets/&quot;,//可加上完整的url，效果与上面一致</span><br><span class="line"></span><br><span class="line">        // filename 指输出的每个js模块名称及存放路径的定义，会影响在html中模块的引用路径</span><br><span class="line">        filename: &quot;js/bundle.js&quot;,  // 单页应用只有一个入口文件时使用，在html页面上通过&lt;script src=&quot;/js/bundle.js&quot;&gt;&lt;/script&gt;引用入口模块</span><br><span class="line">        filename: &quot;js/[name].js&quot;,  // 传统多页应用有多个入口文件时使用，[name] 代入entry配置中的任意一项模块的名称，如：index, 在不同的页面上引用不同的入口，例如在index.html页面上通过&lt;script src=&quot;/js/index.js&quot;&gt;&lt;/script&gt;引用入口模块</span><br><span class="line">        filename: &quot;js/[hash]/[chunkhash].js&quot;,  // 为生产环境实现前端静态资源增量更新时使用，[hash]是根据每次编译后项目总体文件的hash值, [chunkhash]是根据每个模块内容计算出的hash值</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>path: 打包文件存放的绝对路径<br>publicPath: 网站运行时的访问路径<br>filename:打包后的文件名<br>当我们在entry中定义构建多个文件时，filename可以对应的更改为[name].js用于定义不同文件构建后的名字。</p>
</blockquote>
<p><strong> module </strong> </p>
<p>在webpack中JavaScript，CSS，LESS，TypeScript，JSX，CoffeeScript，图片等静态文件都是模块，不同模块的加载是通过模块加载器（webpack-loader）来统一管理的。loaders之间是可以串联的，一个加载器的输出可以作为下一个加载器的输入，最终返回到JavaScript上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">module: &#123;</span><br><span class="line"> rules: [</span><br><span class="line">   &#123;</span><br><span class="line">     test: /\.vue$/,</span><br><span class="line">     loader: &apos;vue-loader&apos;,</span><br><span class="line">     //query和options功能相同，推荐使用option</span><br><span class="line">     options: &#123;</span><br><span class="line">       loaders: &#123;</span><br><span class="line">         &apos;scss&apos;: &apos;vue-style-loader!css-loader!sass-loader&apos;,</span><br><span class="line">         &apos;sass&apos;: &apos;vue-style-loader!css-loader!sass-loader?indentedSyntax&apos;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     //把要处理的目录包括进来,多个用［］数组，单个直接写入</span><br><span class="line">     include: [</span><br><span class="line">       path.resolve(__dirname, &quot;app&quot;)</span><br><span class="line">     ],</span><br><span class="line">     //排除不处理的目录</span><br><span class="line">     exclude: /node_modules/      </span><br><span class="line">   &#125;,    </span><br><span class="line">   &#123;</span><br><span class="line">     test: /\.js$/,</span><br><span class="line">     loader: &apos;babel-loader&apos;,</span><br><span class="line">     exclude: /node_modules/,  //排除node_modules文件夹</span><br><span class="line">   &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     test: /\.json$/,</span><br><span class="line">     loader: &apos;json-loader&apos;</span><br><span class="line">   &#125;,      </span><br><span class="line">   &#123;</span><br><span class="line">     test: /\.(png|jpe?g|gif|svg)(\?.*)?$/,</span><br><span class="line">     loader: &apos;file-loader&apos;,</span><br><span class="line">     query: &#123;</span><br><span class="line">       limit: 8192,</span><br><span class="line">       name: &apos;./images/[name].[ext]?[hash]&apos;</span><br><span class="line">     &#125;,</span><br><span class="line"></span><br><span class="line">   &#125;,     </span><br><span class="line">   // 使用多个插件，使用use，sass文件使用style-loader, css-loader, less-loader来处理</span><br><span class="line">   &#123;</span><br><span class="line">       test: /\.(sass|scss)$/,</span><br><span class="line">       use: [</span><br><span class="line">           &apos;style-loader&apos;,</span><br><span class="line">           &apos;css-loader&apos;,</span><br><span class="line">           &apos;sass-loader&apos;,</span><br><span class="line">           extractTextPlugin.extract([&apos;style&apos;,&apos;css&apos;, &apos;less&apos;])     </span><br><span class="line">       ],</span><br><span class="line">   &#125;</span><br><span class="line"> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意<br>webpack 2.x 之后 module.loaders改成了module.rules<br>webpack1.x中loaders可以链式调用，在2.x中使用rule.use配置项替换<br>取消在模块中自动添加-loader后缀</p>
</blockquote>
<p><strong> resolve </strong> </p>
<p>webpack在构建包的时候会按目录的进行文件的查找，resolve属性中的extensions数组中用于配置程序可以自行补全哪些文件后缀：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">resolve: &#123;</span><br><span class="line">       //查找module的话从这里开始查找</span><br><span class="line">       root: &apos;/pomy/github/flux-example/src&apos;, //绝对路径</span><br><span class="line">       //自动扩展文件后缀名，意味着我们require模块可以省略不写后缀名</span><br><span class="line">       extensions: [&apos;&apos;, &apos;.js&apos;, &apos;.json&apos;, &apos;.scss&apos;],</span><br><span class="line">       //模块别名定义，方便后续直接引用别名，无须多写长长的地址</span><br><span class="line">       alias: &#123;</span><br><span class="line">           AppStore : &apos;js/stores/AppStores.js&apos;,//后续直接 require(&apos;AppStore&apos;) 即可</span><br><span class="line">           ActionType : &apos;js/actions/ActionType.js&apos;,</span><br><span class="line">           AppAction : &apos;js/actions/AppAction.js&apos;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>然后我们想要加载一个js文件时，只要 require(‘common’)就可以加载common.js文件了。</p>
<p>注意一下, extensions 第一个是空字符串 ! 对应不需要后缀的情况.</p>
<p><strong> plugin </strong> </p>
<p>webpack提供了[丰富的组件]用来满足不同的需求，当然我们也可以自行实现一个组件来满足自己的需求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins: [</span><br><span class="line">     //your plugins list</span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>
<p>在webpack中编写js文件时，可以通过require的方式引入其他的静态资源，可通过loader对文件自动解析并打包文件。通常会将js文件打包合并，css文件会在页面的header中嵌入style的方式载入页面。但开发过程中我们并不想将样式打在脚本中，最好可以独立生成css文件，以外链的形式加载。这时extract-text-webpack-plugin插件可以帮我们达到想要的效果。需要使用npm的方式加载插件，然后参见下面的配置，就可以将js中的css文件提取，并以指定的文件名来进行加载。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install extract-text-webpack-plugin –save-dev</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins: [</span><br><span class="line">    new ExtractTextPlugin(&apos;styles.css&apos;)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><strong> externals </strong> </p>
<p>防止将某些 import 的包(package)打包到 bundle 中，而是在运行时(runtime)再去从外部获取这些扩展依赖(external dependencies)。</p>
<p>例如，从 CDN 引入 jQuery，而不是把它打包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;https://code.jquery.com/jquery-3.1.0.js&quot;</span><br><span class="line">  integrity=&quot;sha256-slogkvB1K3VOkzAI8QITxV3VzpOnkeNVsKvtkYLMjfk=&quot;</span><br><span class="line">  crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">externals: &#123;</span><br><span class="line"> &quot;jquery&quot;: &quot;jQuery&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就剥离了那些不需要改动的依赖模块，换句话，下面展示的代码还可以正常运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import $ from &apos;jquery&apos;;</span><br><span class="line"></span><br><span class="line">$(&apos;.my-element&apos;).animate(...);</span><br></pre></td></tr></table></figure>
<p>关于 webpack.config.js 更详尽的配置可以参考 <a href="https://doc.webpack.org/configuration/" target="_blank" rel="external">这里</a></p>
<h2 id="Webpack常用命令"><a href="#Webpack常用命令" class="headerlink" title="Webpack常用命令"></a>Webpack常用命令</h2><p>webpack的使用通常有三种方式：</p>
<p>1、命令行使用：webpack 其中entry.js是入口文件，result.js是打包后的输出文件<br>2、node.js API使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var webpack = require(&apos;webpack&apos;);</span><br><span class="line">webpack(&#123;</span><br><span class="line">//configuration</span><br><span class="line">&#125;, function(err, stats)&#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>3、默认使用当前目录的 webpack.config.js 作为配置文件。如果要指定另外的配置文件，可以执行：webpack –config webpack.custom.config.js</p>
<p>webpack 的执行也很简单，直接执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpack --display-error-details</span><br></pre></td></tr></table></figure>
<p><strong> 常用命令 </strong> </p>
<p>webpack的使用和browserify有些类似，下面列举几个常用命令：</p>
<blockquote>
<p>webpack 最基本的启动webpack命令<br>webpack -w 提供watch方法，实时进行打包更新<br>webpack -p 对打包后的文件进行压缩<br>webpack -d 提供SourceMaps，方便调试<br>webpack –colors 输出结果带彩色，比如：会用红色显示耗时较长的步骤<br>webpack –profile 输出性能数据，可以看到每一步的耗时<br>webpack –display-modules 默认情况下 node_modules 下的模块会被隐藏，加上这个参数可以显示这些被隐藏的模块</p>
</blockquote>
<p>参考资料：</p>
<p><a href="https://webpack.js.org" target="_blank" rel="external">webpack</a><br><a href="https://doc.webpack-china.org/" target="_blank" rel="external">webpack中文文档</a><br><a href="https://segmentfault.com/a/1190000008259868" target="_blank" rel="external">【翻译向】webpack2 指南（上）</a><br><a href="https://segmentfault.com/a/1190000008260180" target="_blank" rel="external">【翻译向】webpack2 指南（中）</a><br><a href="https://segmentfault.com/a/1190000008261590" target="_blank" rel="external">【翻译向】webpack2 指南（下）</a><br><a href="//www.aliued.com/?p=4060">今天，你升级Webpack2了吗？</a><br><a href="https://www.vanadis.cn/2017/03/26/webpack/" target="_blank" rel="external">webpack使用小记</a><br><a href="https://github.com/cssmagic/blog/issues/58" target="_blank" rel="external">Webpack 2 有哪些新东西</a><br><a href="//imweb.io/topic/5868e1abb3ce6d8e3f9f99bb">webpack2 终极优化</a><br><a href="//imweb.io/topic/5868e1abb3ce6d8e3f9f99bb">基于webpack搭建前端工程解决方案探索</a><br><a href="https://segmentfault.com/a/1190000002551952" target="_blank" rel="external">webpack入门</a><br><a href="https://github.com/lcxfs1991/blog/issues/2" target="_blank" rel="external">webpack使用优化（基本篇</a><br><a href="https://github.com/ogoodo/url/issues/12" target="_blank" rel="external">webPack 参考</a><br><a href="https://github.com/youngwind/blog/issues/65" target="_blank" rel="external">webpack打包bundle.js体积大小优化</a><br><a href="https://segmentfault.com/a/1190000005770042" target="_blank" rel="external">开发工具心得：如何 10 倍提高你的 Webpack 构建效率</a><br><a href="https://github.com/dwqs/blog/issues/21" target="_blank" rel="external">详解前端模块化工具-Webpack</a><br><a href="https://github.com/shaozj/blog/issues/11" target="_blank" rel="external">webpack 多页面构建</a><br><a href="https://alisec-ued.github.io/2016/12/13/%E4%BD%BF%E7%94%A8Webpack%E6%89%93%E5%8C%85%E6%97%B6%E7%9A%84%E2%80%9C%E5%A4%9A%E9%A1%B5%E2%80%9D%E5%AE%9E%E8%B7%B5/" target="_blank" rel="external">使用Webpack打包时的“多页”实践</a><br><a href="https://segmentfault.com/a/1190000008279459" target="_blank" rel="external">Webpack2.x踩坑与总结</a><br><a href="https://github.com/chemdemo/chemdemo.github.io/issues/13" target="_blank" rel="external">Webpack——令人困惑的地方</a></p>

      
    </div>

    <!-- S 打赏模块 -->
    <div class="pfan_payment" style="max-width: 500px;margin: 0 auto">
        <img src="http://img.pfan123.com/payment.png" alt="" style="width: 100%;height: 10%;">
    </div>
    <!-- E 打赏模块 -->


    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack、vue、react、webpack-dev-server/">webpack、vue、react、webpack-dev-server</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
    
</article>











  
    <article id="post-ES6的模块化理解" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/12/ES6的模块化理解/" class="article-date">
  	<time datetime="2017-04-12T02:00:21.000Z" itemprop="datePublished">2017-04-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/12/ES6的模块化理解/">ES6的模块化理解</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前沿"><a href="#前沿" class="headerlink" title="前沿"></a>前沿</h2><p>历史上，JavaScript 一直没有模块（module）体系，无法将一个大程序拆分成互相依赖的小文件，再用简单的方法拼装来。其他语言都有这项功能，比如 Ruby 的<code>require</code>、Python 的<code>import</code>，甚至就连 CSS 都有<code>@import</code>，但是JavaScript任何这方面的支持都没有，这对开发大型的、复杂的项目形成了巨大障碍。</p>
<p>在 ES6 之前，社区制定了一些模块加载方案，最主要的有 CommonJS 和 AMD 两种。前者用于服务器，后者用于浏览器。ES6 在语言标准的层面上，实现了模块功能，而且实现得相当简单，完全可以取代 CommonJS 和 AMD 规范，成为浏览器和服务器通用的模块解决方案。</p>
<p>现在ES6自带了模块化，可以直接作用import和export在浏览器中导入和导出各个模块。每一个ES6模块都是一个包含JS代码的文件，模块本质上就是一段脚本，而不是用 module 关键字定义一个模块，但是模块与脚本还是有两点区别：</p>
<ul>
<li>在ES6模块中，无论你是否加入“use strict;”语句，默认情况下模块都是在严格模式下运行。</li>
<li>在模块中你可以使用import和export关键字。</li>
</ul>
<p>现代浏览器对模块(module)支持程度不同， 目前都是使用babelJS， 或者Traceur把ES6代码转化为兼容ES5版本的js代码.</p>
<h2 id="ES6的模块化特点"><a href="#ES6的模块化特点" class="headerlink" title="ES6的模块化特点"></a>ES6的模块化特点</h2><p>1.每一个模块只加载一次， 每一个JS只执行一次， 如果下次再去加载同目录下同文件，直接从内存中读取。 一个模块就是一个单例，或者说就是一个对象；</p>
<p>2.每一个模块内声明的变量都是局部变量， 不会污染全局作用域；</p>
<p>3.模块内部的变量或者函数可以通过export导出；</p>
<p>4.一个模块可以导入别的模块</p>
<h2 id="export-命令"><a href="#export-命令" class="headerlink" title="export 命令"></a>export 命令</h2><p>模块功能主要由两个命令构成：<code>export</code>和<code>import</code>。<code>export</code>命令用于规定模块的对外接口，<code>import</code>命令用于输入其他模块提供的功能。</p>
<p>一个模块就是一个独立的文件。该文件内部的所有变量，外部无法获取。如果你希望外部能够读取模块内部的某个变量，就必须使用export关键字输出该变量。</p>
<p>1.<code>export</code>命令输出变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//导出变量</span><br><span class="line">export var firstName = &apos;Michael&apos;;</span><br><span class="line">export var lastName = &apos;Jackson&apos;;</span><br><span class="line">export var year = 1958;</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line"></span><br><span class="line">var firstName = &apos;Michael&apos;</span><br><span class="line">var lastName = &apos;Jackson&apos;</span><br><span class="line"></span><br><span class="line">export &#123;firstName, lastName&#125;</span><br></pre></td></tr></table></figure>
<p>2.<code>export</code>命令输出函数或类（class）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//导出函数</span><br><span class="line">export function multiply(x, y) &#123;</span><br><span class="line">  return x * y;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//导出类</span><br><span class="line">export class Point &#123;</span><br><span class="line">  constructor(x, y) &#123;</span><br><span class="line">    this.x = x;</span><br><span class="line">    this.y = y;</span><br><span class="line">  &#125;</span><br><span class="line">  toString() &#123;</span><br><span class="line">    return &apos;(&apos;+this.x+&apos;, &apos;+this.y+&apos;)&apos;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通常情况下，<code>export</code> 输出的变量就是本来的名字，但是可以使用as关键字重命名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function v1() &#123; ... &#125;</span><br><span class="line">function v2() &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">export &#123;</span><br><span class="line">  v1 as streamV1,</span><br><span class="line">  v2 as streamV2,</span><br><span class="line">  v2 as streamLatestVersion</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面代码使用as关键字，重命名了函数v1和v2的对外接口。重命名后，v2可以用不同的名字输出两次。</p>
<p><code>注意</code>： 需要特别注意的是，export命令规定的是对外的接口，必须与模块内部的变量建立一一对应关系。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 报错</span><br><span class="line">export 1;</span><br><span class="line"></span><br><span class="line">// 报错</span><br><span class="line">var m = 1;</span><br><span class="line">export m;</span><br></pre></td></tr></table></figure>
<p>上面两种写法都会报错，因为没有提供对外的接口。第一种写法直接输出1，第二种写法通过变量<code>m</code>，还是直接输出1。<code>1</code>只是一个值，不是接口。正确的写法是下面这样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 写法一</span><br><span class="line">export var m = 1;</span><br><span class="line"></span><br><span class="line">// 写法二</span><br><span class="line">var m = 1;</span><br><span class="line">export &#123;m&#125;;</span><br><span class="line"></span><br><span class="line">// 写法三</span><br><span class="line">var n = 1;</span><br><span class="line">export &#123;n as m&#125;;</span><br></pre></td></tr></table></figure>
<p>上面三种写法都是正确的，规定了对外的接口<code>m</code>。其他脚本可以通过这个接口，取到值<code>1</code>。它们的实质是，在接口名与模块内部变量之间，建立了一一对应的关系。</p>
<p>同样的，<code>function</code>和<code>class</code>的输出，也必须遵守这样的写法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 报错</span><br><span class="line">function f() &#123;&#125;</span><br><span class="line">export f;</span><br><span class="line"></span><br><span class="line">// 正确</span><br><span class="line">export function f() &#123;&#125;;</span><br><span class="line"></span><br><span class="line">// 正确</span><br><span class="line">function f() &#123;&#125;</span><br><span class="line">export &#123;f&#125;;</span><br></pre></td></tr></table></figure>
<p>另外，<code>export</code>语句输出的接口，与其对应的值是动态绑定关系，即通过该接口，可以取到模块内部实时的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export var foo = &apos;bar&apos;;</span><br><span class="line">setTimeout(() =&gt; foo = &apos;baz&apos;, 500);</span><br></pre></td></tr></table></figure>
<p>上面代码输出变量<code>foo</code>，值为<code>bar</code>，500毫秒之后变成<code>baz</code>。</p>
<p>最后，<code>export</code>命令可以出现在模块的任何位置，只要处于模块顶层就可以。如果处于块级作用域内，就会报错，下一节的<code>import</code>命令也是如此。这是因为处于条件代码块之中，就没法做静态优化了，违背了ES6模块的设计初衷。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function foo() &#123;</span><br><span class="line">  export default &apos;bar&apos; // SyntaxError</span><br><span class="line">&#125;</span><br><span class="line">foo()</span><br></pre></td></tr></table></figure></p>
<p>上面代码中，<code>export</code>语句放在函数之中，结果报错。</p>
<h2 id="import-命令"><a href="#import-命令" class="headerlink" title="import 命令"></a>import 命令</h2><p>使用<code>export</code>命令定义了模块的对外接口以后，其他 JS 文件就可以通过<code>import</code>命令加载这个模块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// main.js</span><br><span class="line">import &#123;firstName, lastName, year&#125; from &apos;./profile&apos;;</span><br><span class="line"></span><br><span class="line">function setName(element) &#123;</span><br><span class="line">  element.textContent = firstName + &apos; &apos; + lastName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码的<code>import</code>命令，用于加载<code>profile.js</code>文件，并从中输入变量。<code>import</code>命令接受一对大括号，里面指定要从其他模块导入的变量名。大括号里面的变量名，必须与被导入模块（<code>profile.js</code>）对外接口的名称相同。</p>
<p>如果想为输入的变量重新取一个名字，<code>import</code>命令要使用<code>as</code>关键字，将输入的变量重命名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#123; lastName as surname &#125; from &apos;./profile&apos;;</span><br></pre></td></tr></table></figure>
<p><code>import</code>后面的<code>from</code>指定模块文件的位置，可以是相对路径，也可以是绝对路径，<code>.js</code>路径可以省略。如果只是模块名，不带有路径，那么必须有配置文件，告诉 JavaScript 引擎该模块的位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#123;myMethod&#125; from &apos;util&apos;;</span><br></pre></td></tr></table></figure>
<p>上面代码中，<code>util</code>是模块文件名，由于不带有路径，必须通过配置，告诉引擎怎么取到这个模块。</p>
<p>注意，<code>import</code>命令具有提升效果，会提升到整个模块的头部，首先执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">foo();</span><br><span class="line"></span><br><span class="line">import &#123; foo &#125; from &apos;my_module&apos;;</span><br></pre></td></tr></table></figure>
<p>上面的代码不会报错，因为<code>import</code>的执行早于<code>foo</code>的调用。这种行为的本质是，<code>import</code>命令是编译阶段执行的，在代码运行之前。</p>
<p>由于<code>import</code>是静态执行，所以不能使用表达式和变量。</p>
<h2 id="export-default命令"><a href="#export-default命令" class="headerlink" title="export default命令"></a>export default命令</h2><p>从前面的例子可以看出，使用<code>import</code>命令的时候，用户需要知道所要加载的变量名或函数名，否则无法加载。但是，用户肯定希望快速上手，未必愿意阅读文档，去了解模块有哪些属性和方法。</p>
<p>为了给用户提供方便，就要用到<code>export default</code>命令，为模块指定默认输出。</p>
<p>其他模块加载该模块时，<code>import</code> 命令可以为该匿名函数指定任意名字。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// export-default.js</span><br><span class="line">export default function () &#123;</span><br><span class="line">  console.log(&apos;foo&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码的<code>import</code>命令，可以用任意名称指向<code>export-default.js</code>输出的方法，这时就不需要知道原模块输出的函数名。需要注意的是，这时<code>import</code>命令后面，不使用大括号。</p>
<p><code>export default</code>命令用在非匿名函数前，也是可以的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// export-default.js</span><br><span class="line">export default function foo() &#123;</span><br><span class="line">  console.log(&apos;foo&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 或者写成</span><br><span class="line"></span><br><span class="line">function foo() &#123;</span><br><span class="line">  console.log(&apos;foo&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default foo;</span><br></pre></td></tr></table></figure>
<p>参考资料：</p>
<p><a href="//blog.csdn.net/sahusoft/article/details/7388617">“error while loading shared libraries: xxx.so.x” 错误的原因和解决办法</a></p>
<p><a href="https://www.zhihu.com/question/20351507/answer/14859415" target="_blank" rel="external">AMD 和 CMD 的区别有哪些</a></p>
<p><a href="https://github.com/seajs/seajs/issues/277" target="_blank" rel="external">SeaJS和RequireJS的异同</a></p>
<p><a href="//www.infoq.com/cn/articles/es6-in-depth-modules">深入浅出ES6（十六）：模块Modules - InfoQ</a></p>
<p><a href="//es6.ruanyifeng.com/#docs/module">Module 的语法–阮一峰</a></p>

      
    </div>

    <!-- S 打赏模块 -->
    <div class="pfan_payment" style="max-width: 500px;margin: 0 auto">
        <img src="http://img.pfan123.com/payment.png" alt="" style="width: 100%;height: 10%;">
    </div>
    <!-- E 打赏模块 -->


    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ES6、module、import、export/">ES6、module、import、export</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
    
</article>











  
    <article id="post-移动端图片上传旋转问题" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/06/移动端图片上传旋转问题/" class="article-date">
  	<time datetime="2017-04-06T02:00:21.000Z" itemprop="datePublished">2017-04-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/06/移动端图片上传旋转问题/">移动端图片上传旋转问题</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在处理移动端选择图片实时预览并上传时遇到一个问题：上传前图片使用img标签预览正常，但通过canvas对图片进行裁切处理，有时会出现图片翻转的问题，一般是翻转 90 度。后经一翻测试研究，发现横向拍照，正常，竖直拍照图片出现旋转90度，后来发现图片拍照会有 Exif 信息存在方向问题。</p>
<blockquote>
<p>PS：其实，大部分的图片查看客户端早已支持自动旋转，所以一般情况下数码设备拍的照片用电脑看，方向都是正确的。许多缩略图生成程序，也是可以指定缩放前自动旋转的（例如 ImageMagick 的 -auto-orient 参数）。</p>
</blockquote>
<h2 id="EXIF"><a href="#EXIF" class="headerlink" title="EXIF"></a>EXIF</h2><p>EXIF 全称 (Exchangeable Image File Format) 照相机拍摄图像一般都由两大部分组成，一部分是数据本身，它记录了每个像素的颜色值，另外一部分是文件头，这里面记录着形如图像的宽度，高度等信息。所讨论的方向信息便是被存储于文件头中。更为具体一些：百度百科中对其 <a href="http://baike.baidu.com/item/EXIF%E4%BF%A1%E6%81%AF" target="_blank" rel="external">EXIF</a> 的解释为：</p>
<blockquote>
<p>可交换图像文件格式常被简称为Exif（Exchangeable image file format），是专门为数码相机的照片设定的，可以记录数码照片的属性信息和拍摄数据… Exif可以附加于JPEG、TIFF、RIFF等文件之中。</p>
</blockquote>
<p>注意：PNG格式的图像中不包含。</p>
<p><img src="http://img.pfan123.com/exif/exif_1.png" alt="Exif 信息"></p>
<p>当然，Exif 中的 Orientation 属性，取决于拍照的设备是否拥有方向传感器。不过根据我的了解，目前大部分数码拍照设备都支持记录方向。1 是默认值，2、4、5、7 表示照片进行了翻转。一般情况下，取值应该是 1、3、6、8 中的一种。下面有张更形象的图描述了具体的旋转策略：</p>
<p><img src="http://img.pfan123.com/exif/exif_2.png" alt="Exif 信息"></p>
<h2 id="获取EXIF旋转图片"><a href="#获取EXIF旋转图片" class="headerlink" title="获取EXIF旋转图片"></a>获取EXIF旋转图片</h2><p>如何从图片中获取 Exif 信息，各个语言都有封装好的代码可以直接使用。推荐一个比较好用的库，api也比较齐全 <a href="https://github.com/exif-js/exif-js/" target="_blank" rel="external">exif-js</a>，它做法分为两步，首先判断 img.src，如果是 Data URI（即base64）则通过 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WindowBase64/Base64_encoding_and_decoding" target="_blank" rel="external">atob</a> 函数转解码base-64编码字符串换为二进制，如果是 Object URL 通过 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader/readAsArrayBuffer" target="_blank" rel="external">readAsArrayBuffer</a> 函数读取二进制，反之则通过 Ajax 获取原始二进制；第二步是从原始数据不同位置匹配获取相关信息，基本是体力活了。</p>
<p>从图片 Exif 信息中取到 Orientation 后，就可以根据它来自动旋转图片了，示例代码: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">input.addEventListener(&quot;change&quot;, function()&#123;</span><br><span class="line">     var file = this.files[0];</span><br><span class="line"></span><br><span class="line">     // 接受 jpeg, jpg, png 类型的图片</span><br><span class="line">     // if (!/\/(?:jpeg|jpg|png)/i.test(file.type)) return;</span><br><span class="line"></span><br><span class="line">     var reader = new FileReader();</span><br><span class="line">     var compressCanvas = document.querySelector(&quot;.babyhappy_compressimg_con&quot;);</span><br><span class="line">     compressCtx = compressCanvas.getContext(&quot;2d&quot;);</span><br><span class="line"></span><br><span class="line">     reader.onload = function(event) &#123;</span><br><span class="line">         var result = this.result;</span><br><span class="line">         var image = new  Image();</span><br><span class="line">         image.src = reader.result;</span><br><span class="line"></span><br><span class="line">         image.onload = function()&#123;</span><br><span class="line">           EXIF.getData(image, function()&#123;</span><br><span class="line">             EXIF.getAllTags(this);</span><br><span class="line">             var orientation = EXIF.getTag(this, &apos;Orientation&apos;);       </span><br><span class="line">             switch(orientation)&#123;</span><br><span class="line">                 case 1:</span><br><span class="line">                     //0°</span><br><span class="line">                     compressCanvas.height = image.height;</span><br><span class="line">                     compressCanvas.width = image.width;</span><br><span class="line">                     compressCtx.clearRect(0, 0, compressCanvas.width, compressCanvas.height)</span><br><span class="line">                     compressCtx.drawImage(image, 0, 0, image.width, image.height);</span><br><span class="line">                     break;</span><br><span class="line">                 case 6:</span><br><span class="line">                     //顺时针90°</span><br><span class="line">                     compressCanvas.width = image.height;</span><br><span class="line">                     compressCanvas.height = image.width;</span><br><span class="line">                     compressCtx.clearRect(0, 0, compressCanvas.width, compressCanvas.height)</span><br><span class="line">                     compressCtx.translate(0, 0);</span><br><span class="line">                     compressCtx.rotate(90 * Math.PI / 180);</span><br><span class="line">                     compressCtx.drawImage(image, 0, -image.height, image.width, image.height);</span><br><span class="line">                     break;</span><br><span class="line">                 case 8:</span><br><span class="line">                     //逆时针90°</span><br><span class="line">                     compressCanvas.width = image.height;</span><br><span class="line">                     compressCanvas.height = image.width;</span><br><span class="line">                     compressCtx.clearRect(0, 0, compressCanvas.width, compressCanvas.height)</span><br><span class="line">                     compressCtx.translate(0, 0);</span><br><span class="line">                     compressCtx.rotate(-90 * Math.PI / 180);</span><br><span class="line">                     compressCtx.drawImage(image, -image.width, 0, image.width, image.height);</span><br><span class="line">                     break;</span><br><span class="line">                 case 3:</span><br><span class="line">                     //180°</span><br><span class="line">                     compressCanvas.height = image.height;</span><br><span class="line">                     compressCanvas.width = image.width;</span><br><span class="line">                     compressCtx.clearRect(0, 0, compressCanvas.width, compressCanvas.height)</span><br><span class="line">                     compressCtx.translate(0, 0);</span><br><span class="line">                     compressCtx.rotate(Math.PI);</span><br><span class="line">                     compressCtx.drawImage(image, -image.width, -image.height, image.width, image.height);</span><br><span class="line">                     break;</span><br><span class="line">                 default:</span><br><span class="line">                     compressCanvas.height = image.height;</span><br><span class="line">                     compressCanvas.width = image.width;</span><br><span class="line">                     compressCtx.clearRect(0, 0, compressCanvas.width, compressCanvas.height)</span><br><span class="line">                     compressCtx.drawImage(image, 0, 0, image.width, image.height);</span><br><span class="line">             &#125;</span><br><span class="line">              var base64 = compressCanvas.toDataURL(&quot;image/jpeg&quot;, .5);    </span><br><span class="line"></span><br><span class="line">           &#125;)                    </span><br><span class="line">                           </span><br><span class="line">         &#125;</span><br><span class="line">     reader.readAsDataURL(file);                        </span><br><span class="line">   &#125;, false)</span><br></pre></td></tr></table></figure>
<p><a href="http://jdc.jd.com/fd/h5/1703/babyhappy/index.html#crop" target="_blank" rel="external">示例演示demo</a></p>
<p>参考资料：</p>
<p><a href="http://code.ciaoca.com/javascript/exif-js/" target="_blank" rel="external">Exif.js 读取图像的元数据</a><br><a href="https://github.com/exif-js/exif-js/" target="_blank" rel="external">exif-js github</a><br><a href="http://tgideas.qq.com/webplat/info/news_version3/804/808/811/m579/201409/278736.shtml" target="_blank" rel="external">H5拍照应用开发经历的那些坑儿</a><br><a href="https://imququ.com/post/how-to-auto-rotate-photo-in-js.html" target="_blank" rel="external">图片自动旋转的前端实现方案</a></p>

      
    </div>

    <!-- S 打赏模块 -->
    <div class="pfan_payment" style="max-width: 500px;margin: 0 auto">
        <img src="http://img.pfan123.com/payment.png" alt="" style="width: 100%;height: 10%;">
    </div>
    <!-- E 打赏模块 -->


    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/exif，oritation，input，file/">exif，oritation，input，file</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
    
</article>











  
    <article id="post-git生成ssh key及本地解决多个ssh key的问题" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/05/git生成ssh key及本地解决多个ssh key的问题/" class="article-date">
  	<time datetime="2017-04-05T02:00:21.000Z" itemprop="datePublished">2017-04-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/05/git生成ssh key及本地解决多个ssh key的问题/">git生成ssh key及本地解决多个ssh key的问题</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ssh是一种网络协议，用于计算机之间的加密登录。</p>
<h2 id="生成ssh-key步骤"><a href="#生成ssh-key步骤" class="headerlink" title="生成ssh key步骤"></a>生成ssh key步骤</h2><p>这里以配置github的ssh key为例：</p>
<p>1.配置git用户名和邮箱</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config user.name &quot;用户名&quot;</span><br><span class="line">git config user.email &quot;邮箱&quot;</span><br></pre></td></tr></table></figure>
<p>在config后加上 –global 即可全局设置用户名和邮箱。</p>
<p>2.生成ssh key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;邮箱&quot;</span><br></pre></td></tr></table></figure>
<p>然后根据提示连续回车即可在~/.ssh目录下得到id_rsa和id_rsa.pub两个文件，id_rsa.pub文件里存放的就是我们要使用的key。</p>
<p>3.上传key到github</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clip &lt; ~/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure>
<ul>
<li>复制key到剪贴板</li>
<li>登录github</li>
<li>点击右上方的Accounting settings图标</li>
<li>选择 SSH key</li>
<li>点击 Add SSH key</li>
</ul>
<p>4.测试是否配置成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure>
<p>如果配置成功，则会显示：<br>Hi username! You’ve successfully authenticated, but GitHub does not provide shell access.</p>
<h2 id="解决本地多个ssh-key问题"><a href="#解决本地多个ssh-key问题" class="headerlink" title="解决本地多个ssh key问题"></a>解决本地多个ssh key问题</h2><p>有的时候，不仅github使用ssh key，工作项目或者其他云平台可能也需要使用ssh key来认证，如果每次都覆盖了原来的id_rsa文件，那么之前的认证就会失效。这个问题我们可以通过在~/.ssh目录下增加config文件来解决。</p>
<p>下面以配置jdresource平台的ssh key为例。</p>
<p>1.第一步依然是配置git用户名和邮箱</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config user.name &quot;用户名&quot;</span><br><span class="line">git config user.email &quot;邮箱&quot;</span><br></pre></td></tr></table></figure>
<p>2.生成ssh key时同时指定保存的文件名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -f ~/.ssh/id_rsa.jd -C &quot;email&quot;</span><br></pre></td></tr></table></figure>
<p>上面的id_rsa.jd就是我们指定的文件名，这时~/.ssh目录下会多出id_rsa.jd和id_rsa.jd.pub两个文件，id_rsa.jd.pub里保存的就是我们要使用的key。</p>
<p>3.新增并配置config文件</p>
<p>添加config文件</p>
<p>如果config文件不存在，先添加；存在则直接修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch ~/.ssh/config</span><br></pre></td></tr></table></figure>
<p>在config文件里添加如下内容(User表示你的用户名)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Host *.jd.com</span><br><span class="line">    IdentityFile ~/.ssh/id_rsa.jd</span><br><span class="line">    User test</span><br></pre></td></tr></table></figure></p>
<p>4.上传key到云平台后台(省略)</p>
<p>5.测试ssh key是否配置成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@git.source.jd.com</span><br></pre></td></tr></table></figure>
<p>成功的话会显示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Welcome to GitLab, username!</span><br></pre></td></tr></table></figure></p>
<p>至此，本地便成功配置多个ssh key。日后如需添加，则安装上述配置生成key，并修改config文件即可。</p>

      
    </div>

    <!-- S 打赏模块 -->
    <div class="pfan_payment" style="max-width: 500px;margin: 0 auto">
        <img src="http://img.pfan123.com/payment.png" alt="" style="width: 100%;height: 10%;">
    </div>
    <!-- E 打赏模块 -->


    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssh，Nginx/">ssh，Nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
    
</article>











  
    <article id="post-配置Nginx，开启HTTP:2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/13/配置Nginx，开启HTTP:2/" class="article-date">
  	<time datetime="2017-03-13T02:00:21.000Z" itemprop="datePublished">2017-03-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/13/配置Nginx，开启HTTP:2/">部署 HTTP/2</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HTTP-2-是什么？"><a href="#HTTP-2-是什么？" class="headerlink" title="HTTP/2 是什么？"></a>HTTP/2 是什么？</h2><p>HTTP/2（超文本传输协议第2版，最初命名为<a href="https://zh.wikipedia.org/wiki/HTTP" target="_blank" rel="external">HTTP 2.0</a> ），是HTTP协议的的第二个主要版本，使用于万维网。HTTP/2是HTTP协议自1999年HTTP 1.1发布后的首个更新，主要基于<a href="https://zh.wikipedia.org/wiki/SPDY" target="_blank" rel="external">SPDY</a>协议。它由互联网工程任务组（IETF）的Hypertext Transfer Protocol Bis（httpbis）工作小组进行开发。与 HTTP1.1 完全语义兼容，几乎可以无缝升级。目前主流浏览器都已经支持 HTTP/2 了（IE 自 IE 11 开始支持）。</p>
<blockquote>
<p>早些时候，Nginx 曾发布过一个 early-alpha patch 来提供对 HTTP/2 的支持，但从最新发布的 Nginx 1.9.5 开始，httpv2module 已经替换了 ngxhttpspdy_module 并正式开始提供全面的 HTTP/2 支持。</p>
</blockquote>
<p>下面说下如何升级到HTTP/2，目前我的nginx版本为 1.10.3 ：</p>
<h2 id="升级-OpenSSL"><a href="#升级-OpenSSL" class="headerlink" title="升级 OpenSSL"></a>升级 OpenSSL</h2><blockquote>
<p>Note that accepting HTTP/2 connections over TLS requires the “Application-Layer Protocol Negotiation” (ALPN) TLS extension support, which is available only since OpenSSL version 1.0.2. Using the “Next Protocol Negotiation” (NPN) TLS extension for this purpose (available since OpenSSL version 1.0.1) is not guaranteed.</p>
</blockquote>
<p>官方提到，目前升级 HTTP/2 使用 ALPN，OpenSSL需要在 1.0.2 之上。</p>
<p>1.检查OpenSSL版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl version</span><br></pre></td></tr></table></figure>
<p>如果版本不够可以，在<a href="https://www.openssl.org/source/" target="_blank" rel="external">OpenSSL</a>下载。</p>
<p>2.下载 OpenSSL 的最新版，当前最新版本为1.1.0e</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.openssl.org/source/openssl-1.1.0e.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf openssl-1.1.0e.tar.gz</span><br><span class="line"></span><br><span class="line">mv openssl-1.1.0e／ openssl</span><br></pre></td></tr></table></figure>
<p>3.编译安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./config --prefix=/usr --openssldir=/etc/ssl --libdir=lib shared zlib-dynamic</span><br><span class="line">make depend</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>4.检查版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl version</span><br><span class="line">OpenSSL 1.1.0e  16 Feb 2017</span><br></pre></td></tr></table></figure>
<h2 id="Nginx启动HTTP-2"><a href="#Nginx启动HTTP-2" class="headerlink" title="Nginx启动HTTP/2"></a>Nginx启动HTTP/2</h2><p>开启HTTP/2也十分简单，直接在指定的域名nginx.conf中配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;  </span><br><span class="line">  listen        443 ssl http2; </span><br><span class="line">  server_name   luolei.org;</span><br><span class="line"></span><br><span class="line">  #SSL配置</span><br><span class="line">  ssl                   on;</span><br><span class="line">  ssl_certificate       /etc/nginx/conf.d/certificate.crt;</span><br><span class="line">  ssl_certificate_key   /etc/nginx/conf.d/certificate.key;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在listen后面增加http2即可。</p>
<blockquote>
<p>注意:不能混用SPDY和HTTP/2，如果你两个都同时开启，会报错。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx: [warn] invalid parameter &quot;spdy&quot;: ngx_http_spdy_module was superseded by ngx_http_v2_module in /etc/nginx/conf.d/vhost.conf:12</span><br></pre></td></tr></table></figure>
<h2 id="配置Nginx"><a href="#配置Nginx" class="headerlink" title="配置Nginx"></a>配置Nginx</h2><p>Nginx 配置 http_v2_module 和 http_ssl_module 两个模块，以及最新openssl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-openssl=.././openssl --with-http_v2_module --with-http_ssl_module</span><br></pre></td></tr></table></figure>
<p>重启nginx服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service nginx restart</span><br></pre></td></tr></table></figure>
<p>重启服务器之后，打开chrome浏览器，进入网络Network，打开Protocol，看到主域的Protocol已经变了成了h2，这就意味着已经成功升级到HTTP/2。<br><img src="http://img.pfan123.com/http2_2_2.png" alt="http2"></p>
<p>或者使用Chrome的网络工具，在地址栏中输入chrome://net-internals/#http2</p>
<p><img src="http://img.pfan123.com/http2_1_1.png" alt="http2"></p>
<p>参考资料：</p>
<p><a href="https://imququ.com/post/http2-resource.html" target="_blank" rel="external">HTTP/2 资料汇总</a></p>
<p><a href="https://imququ.com/post/my-nginx-conf.html" target="_blank" rel="external">本博客 Nginx 配置之完整篇</a></p>
<p><a href="http://blog.csdn.net/sahusoft/article/details/7388617" target="_blank" rel="external">“error while loading shared libraries: xxx.so.x” 错误的原因和解决办法</a></p>
<p><a href="https://www.openssl.org/source/" target="_blank" rel="external">OpenSSL资源下载</a></p>
<p><a href="https://www.qianduan.net/a-simple-performance-comparison-of-https-spdy-and-http2/" target="_blank" rel="external">HTTPS, SPDY和 HTTP/2性能的简单对比</a></p>
<p><a href="http://www.infoq.com/cn/news/2015/02/https-spdy-http2-comparison" target="_blank" rel="external">HTTPS、SPDY和HTTP/2的性能比较</a></p>

      
    </div>

    <!-- S 打赏模块 -->
    <div class="pfan_payment" style="max-width: 500px;margin: 0 auto">
        <img src="http://img.pfan123.com/payment.png" alt="" style="width: 100%;height: 10%;">
    </div>
    <!-- E 打赏模块 -->


    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HTTP-2，Nginx/">HTTP/2，Nginx</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
    
</article>











  
    <article id="post-用 Git Hooks 进行自动部署" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/12/用 Git Hooks 进行自动部署/" class="article-date">
  	<time datetime="2017-03-12T02:00:21.000Z" itemprop="datePublished">2017-03-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/12/用 Git Hooks 进行自动部署/">用 Git 钩子进行自动部署</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Git-钩子"><a href="#Git-钩子" class="headerlink" title="Git 钩子"></a>Git 钩子</h2><p>Git 钩子(hooks)是在 Git 仓库中特定事件(certain points)触发后被调用的脚本。通过钩子可以自定义 Git 内部的相关（如 git push）行为，在开发周期中的关键点触发自定义的行为。Git 含有两种类型的钩子：客户端的和服务器端的。客户端钩子由诸如提交和合并这样的操作所调用，而服务器端钩子作用于诸如接收被推送的提交这样的联网操作。 </p>
<p><img src="https://cdn.rawgit.com/o2team/misc/gh-pages/pfan123/githook/githook_1.png" alt="Webhook1"></p>
<p>Git 钩子最常见的使用场景包括根据仓库状态改变项目环境、接入持续集成工作流等。由于脚本是可以完全定制，所以你可以用 Git 钩子来自动化或者优化你开发工作流中任意部分。</p>
<p>在这篇文章中，我们会先简要介绍 Git 钩子相关要素，然后实例使用 Git 钩子进行博客自动部署。</p>
<h2 id="Git-钩子安装"><a href="#Git-钩子安装" class="headerlink" title="Git 钩子安装"></a>Git 钩子安装</h2><p>Git 钩子存在于每个 Git 仓库的 <code>.git/hooks</code> 目录中。 当你用 <code>git init</code> 初始化一个新版本库时，Git 默认会在这个目录中放置一些示例脚本。所有的示例都是 shell 脚本，其中一些还混杂了 Perl 代码，不过，任何正确命名的可执行脚本都可以正常使用 —— 你可以用 Ruby 或 Python，或其它语言编写它们。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  hooks git:(master) ls</span><br><span class="line">applypatch-msg.sample     pre-applypatch.sample     pre-rebase.sample</span><br><span class="line">commit-msg.sample         pre-commit.sample         prepare-commit-msg.sample</span><br><span class="line">post-update.sample        pre-push.sample           update.sample</span><br></pre></td></tr></table></figure>
<blockquote>
<p>.sample拓展名是为了防止它们默认被执行，安装一个钩子只需要去掉.sample拓展名即可。</p>
</blockquote>
<h2 id="Git-钩子的作用域"><a href="#Git-钩子的作用域" class="headerlink" title="Git 钩子的作用域"></a>Git 钩子的作用域</h2><p>Git 钩子是对本地仓库相关操作影响，对于任何 Git 仓库来说钩子都是本地的，初始的钩子都是从 Git 默认模板目录中自动安装。</p>
<p>在开发团队中为了保持团队所使用钩子一致，维护起来算是比较复杂的，因为 <code>.git/hooks</code> 目录不随你的项目一起拷贝，也不受版本控制影响。</p>
<p><img src="https://cdn.rawgit.com/o2team/misc/gh-pages/pfan123/githook/githook_2.png" alt="Webhook1"></p>
<blockquote>
<p>简单的解决办法是把钩子文件存放在项目的实际目录中（在.git 外），这样就可以像其他文件一样进行版本控制，然后在.git/hooks中创建一个链接，或者简单地在更新后把它们复制到.git/hooks目录下。</p>
</blockquote>
<p>当我们了解了以上 Git 钩子基础知识后，下面我们来实例操作 Git 钩子进行博客自动部署。</p>
<h2 id="Git-钩子进行自动部署"><a href="#Git-钩子进行自动部署" class="headerlink" title="Git 钩子进行自动部署"></a>Git 钩子进行自动部署</h2><p>如何实现 Git 钩子进行自动部署，其实原理很简单，我们只需要监听每次本地 <code>git push</code>到远程服务器，然后远程服务器同步拉取最新文件，重启服务器即可（pm2 reload xx）。</p>
<p><img src="https://cdn.rawgit.com/o2team/misc/gh-pages/pfan123/githook/githook_3.png" alt="Webhook1"></p>
<p>1.在服务器初始化一个远程 Git 裸仓库 (git init –bare)</p>
<p>裸仓库与 <code>git init</code> 初使化的仓库不太一样，裸仓库其实相当于通过克隆来的仓库里的.git文件夹，整个裸仓库中只有git索引（index），不包含工作目录。要实现Push to Deploy，首先我们需要一个裸仓库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git init --bare xxx-bare.git</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line">mkdir xxx-bare.git</span><br><span class="line">cd xxx-bare.git</span><br><span class="line">git init --bare</span><br></pre></td></tr></table></figure>
<p><code>post-update.sample</code>去掉sample， 在里面增加执行脚本:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">#</span><br><span class="line">DIR_ONE=/home/user/deploy-directory</span><br><span class="line">#</span><br><span class="line">cd $DIR_ONE</span><br><span class="line">git clean -fd</span><br><span class="line">#</span><br><span class="line">git checkout --force</span><br></pre></td></tr></table></figure>
<p>2.在服务器初始化一个本地 Git 仓库</p>
<p>在<code>deploy-directory</code>目录 git init 初始化本地仓库，它的作用是拉去远程仓库最新的源码，然后在这个仓库里进行编译，把代码编译到 www 目录（网站的根目录）。</p>
<p><code>post-update.sample</code>去掉sample， 在里面增加执行脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">unset GIT_DIR  </span><br><span class="line">DeployPath=/home/user/Deploy</span><br><span class="line">WwwPath=/home/wwwroot/Deploy</span><br><span class="line">cd $DeployPath</span><br><span class="line">git clean -f</span><br><span class="line">git pull origin master</span><br><span class="line"></span><br><span class="line">ath build WwwPath</span><br><span class="line">＃exec git-update-server-info</span><br></pre></td></tr></table></figure>
<p><code>注意：</code>  一定要<code>unset GIT_DIR</code>清除变量， 不然会引起<code>remote: fatal: Not a git repository: &#39;.&#39;</code>错误。</p>
<p><code>post-update</code>添加执行权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x post-receive</span><br></pre></td></tr></table></figure></p>
<p>3.本地仓库添加 remote 源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git remote add origin user@1.2.3.4:/home/git/xxx-bare.git</span><br><span class="line">//例如git remote add origin ssh://root@41.72.11.11:26244/home/www/BRIDGE_REPO.git</span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure>
<p>参考资料：</p>
<p><a href="https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90" target="_blank" rel="external">自定义 Git - Git 钩子</a><br><a href="https://github.com/geeeeeeeeek/git-recipes/wiki/5.4-Git%E9%92%A9%E5%AD%90%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BD%A0%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81" target="_blank" rel="external">Git钩子：自定义你的工作流</a><br><a href="https://github.com/rvagg/github-webhook-handler" target="_blank" rel="external">github-webhook-handler</a><br><a href="http://sabrinaluo.com/tech/2016/04/14/push-to-deploy-through-git-hook/" target="_blank" rel="external">如何通过Git钩子自动部署(Push to Deploy)</a><br><a href="https://segmentfault.com/a/1190000003836345" target="_blank" rel="external">用 Git Hooks 进行自动部署</a><br><a href="http://stackoverflow.com/questions/4043609/getting-fatal-not-a-git-repository-when-using-post-update-hook-to-execut" target="_blank" rel="external">“fatal: not a git repository: ‘.’”</a></p>

      
    </div>

    <!-- S 打赏模块 -->
    <div class="pfan_payment" style="max-width: 500px;margin: 0 auto">
        <img src="http://img.pfan123.com/payment.png" alt="" style="width: 100%;height: 10%;">
    </div>
    <!-- E 打赏模块 -->


    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webhook，git，-Git-Hooks/">Webhook，git， Git Hooks</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
    
</article>











  
    <article id="post-使用 letsencrypt 生成SSL证书开启https" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/10/使用 letsencrypt 生成SSL证书开启https/" class="article-date">
  	<time datetime="2017-03-10T02:00:21.000Z" itemprop="datePublished">2017-03-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/10/使用 letsencrypt 生成SSL证书开启https/">使用 letsencrypt 生成 SSL 证书开启 HTTPS</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HTTP-和-HTTPS-是什么？"><a href="#HTTP-和-HTTPS-是什么？" class="headerlink" title="HTTP 和 HTTPS 是什么？"></a>HTTP 和 HTTPS 是什么？</h2><p>　 HTTP 是一个传输网页内容的协议，比如你看到的 http 开头的网站 <a href="http://yun.pfan123.com" target="_blank" rel="external">http://yun.pfan123.com</a>，其网页上的文字、图片、CSS、JS 等文件都是通过 http 协议传输到我们浏览器的。</p>
<p>HTTPS（全称：Hyper Text Transfer Protocol over Secure Socket Layer），是以安全为目标的HTTP通道，简单讲是HTTP的安全版。即HTTP下加入SSL层，HTTPS的安全基础是SSL，因此加密的详细内容就需要SSL。</p>
<h2 id="SSL-TLS-是什么？"><a href="#SSL-TLS-是什么？" class="headerlink" title="SSL/TLS 是什么？"></a>SSL/TLS 是什么？</h2><p>SSL是一个介于HTTP协议与TCP之间的一个可选层，其位置大致如下:</p>
<p><img src="http://img.pfan123.com/https_ssl.png" alt="svg基本形状"></p>
<ul>
<li><p>SSL：（Secure Socket Layer，安全套接字层），为Netscape所研发，用以保障在Internet上数据传输之安全，利用数据加密(Encryption)技术，可确保数据在网络上之传输过程中不会被截取。当前版本为3.0，它已被广泛地用于Web浏览器与服务器之间的身份认证和加密数据传输。<br>SSL协议位于TCP/IP协议与各种应用层协议之间，为数据通讯提供安全支持。SSL协议可分为两层： SSL记录协议（SSL Record Protocol）：它建立在可靠的传输协议（如TCP）之上，为高层协议提供数据封装、压缩、加密等基本功能的支持。 SSL握手协议（SSL Handshake Protocol）：它建立在SSL记录协议之上，用于在实际的数据传输开始前，通讯双方进行身份认证、协商加密算法、交换加密密钥等。</p>
</li>
<li><p>TLS：(Transport Layer Security，传输层安全协议)，用于两个应用程序之间提供保密性和数据完整性。<br>TLS 1.0是IETF（Internet Engineering Task Force，Internet工程任务组）制定的一种新的协议，它建立在SSL 3.0协议规范之上，是SSL 3.0的后续版本，可以理解为SSL 3.1，它是写入了 RFC 的。该协议由两层组成： TLS 记录协议（TLS Record）和 TLS 握手协议（TLS Handshake）。较低的层为 TLS 记录协议，位于某个可靠的传输协议（例如 TCP）上面。</p>
</li>
</ul>
<p>SSL/TLS协议提供的服务主要有：</p>
<ul>
<li>1.认证用户和服务器，确保数据发送到正确的客户机和服务器；</li>
<li>2.加密数据以防止数据中途被窃取；</li>
<li>3.维护数据的完整性，确保数据在传输过程中不被改变。</li>
</ul>
<h2 id="HTTPS与HTTP的一些区别"><a href="#HTTPS与HTTP的一些区别" class="headerlink" title="HTTPS与HTTP的一些区别"></a>HTTPS与HTTP的一些区别</h2><p>1.HTTPS协议需要到CA申请证书，一般免费证书很少，需要交费，免费的推荐可以使用 <a href="http://letsencrypt.readthedocs.io/en/latest/using.html#getting-certificates-and-choosing-plugins" target="_blank" rel="external">letsencrypt</a>。<br>2.HTTP协议运行在TCP之上，所有传输的内容都是明文，HTTPS运行在SSL/TLS之上，SSL/TLS运行在TCP之上，所有传输的内容都经过加密的。<br>3.HTTP和HTTPS使用的是完全不同的连接方式，用的端口也不一样，前者是80，后者是443。<br>4.HTTPS可以有效的防止运营商劫持，解决了防劫持的一个大问题。</p>
<h2 id="如何HTTPS部署改造"><a href="#如何HTTPS部署改造" class="headerlink" title="如何HTTPS部署改造"></a>如何HTTPS部署改造</h2><p>一个网站要全站由HTTP替换成HTTPS，可能需要关注以下几点：</p>
<ul>
<li>1.安装CA证书，一般的证书都是需要收费的，这边推荐一个比较好的购买证书网站：1）<a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a>，免费，快捷，支持多域名（不是通配符），三条命令即时签署+导出证书。2）Comodo PositiveSSL，收费，但是比较稳定。</li>
<li>2.在购买证书之后，在证书提供的网站上配置自己的域名，将证书下载下来之后，配置自己的web服务器，同时进行代码改造。</li>
<li>3.HTTPS 降低用户访问速度。SSL握手，HTTPS 对速度会有一定程度的降低，但是只要经过合理优化和部署，HTTPS 对速度的影响完全可以接受。在很多场景下，HTTPS 速度完全不逊于 HTTP，如果使用 SPDY，HTTPS 的速度甚至还要比 HTTP 快。</li>
<li>4.相对于HTTPS降低访问速度，其实更需要关心的是服务器端的CPU压力，HTTPS中大量的密钥算法计算，会消耗大量的CPU资源，只有足够的优化，HTTPS 的机器成本才不会明显增加。</li>
</ul>
<h2 id="Let’s-Encrypt-介绍"><a href="#Let’s-Encrypt-介绍" class="headerlink" title="Let’s Encrypt 介绍"></a>Let’s Encrypt 介绍</h2><p><a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a> 是一个免费、开放，自动化的证书颁发机构，由 ISRG（Internet Security Research Group）运作。</p>
<p>ISRG 是一个关注网络安全的公益组织，其赞助商从非商业组织到财富100强公司都有，包括 Mozilla、Akamai、Cisco、Facebook，密歇根大学等等。ISRG 以消除资金，技术领域的障碍，全面推进加密连接成为互联网标配为自己的使命。</p>
<p>申请 Let’s Encrypt 证书不但免费，还非常简单，虽然每次只有 90 天的有效期，但可以通过<a href="https://certbot.eff.org/" target="_blank" rel="external">certbot</a>脚本定期更新，  Let’s Encrypt有了<a href="https://github.com/certbot/certbot" target="_blank" rel="external">certbot</a>自动化工具，配置管理起来非常容易。</p>
<p><img src="http://img.pfan123.com/https_certbot.png" alt=" certbot生成证书 "></p>
<p>1.下载安装 <code>certbot</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.eff.org/certbot-auto</span><br><span class="line">chmod a+x certbot-auto</span><br></pre></td></tr></table></figure>
<p><img src="http://img.pfan123.com/https_certbot1.png" alt=" certbot生成证书 "></p>
<p>2.获取CA申请证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./certbot-auto certonly</span><br></pre></td></tr></table></figure>
<p><img src="http://img.pfan123.com/https_certbot2.png" alt=" certbot生成证书 "></p>
<p>3.查看 <code>fullchain.pem</code> 和 <code>privkey.pem</code>， 配置nginx</p>
<p>查看 <code>etc/letsencrypt/live/[DOMAIN]/</code>, 发现含有 <code>fullchain.pem</code> 和 <code>privkey.pem</code> ，然后配置 nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">    listen 443 ssl;</span><br><span class="line"></span><br><span class="line">    server_name yun.pfan123.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/yun.pfan123.com/fullchain.pem;</span><br><span class="line"></span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/yun.pfan123.com/privkey.pem;</span><br><span class="line"></span><br><span class="line">    ssl_dhparam /etc/ssl/certs/dhparams.pem;</span><br><span class="line"></span><br><span class="line">    ssl_ciphers &apos;ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA&apos;;</span><br><span class="line"></span><br><span class="line">    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    ……</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.配置 http 强制跳转到 https：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">    listen 80;</span><br><span class="line"></span><br><span class="line">    server_name www.saxieyu.com;</span><br><span class="line"></span><br><span class="line">    return 301 https://$server_name$request_uri;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5.验证服务器证书</p>
<p>如上修改过 nginx 配置，并 reload 过 nginx 服务后，使用浏览器访问 <a href="https://yun.pfan123.com" target="_blank" rel="external">https://yun.pfan123.com</a>，验证服务器证书是否正确生效。</p>
<p>也可以使用 <a href="https://www.ssllabs.com/ssltest/analyze.html" target="_blank" rel="external">ssllabs</a> 在线测试服务器证书强度及配置正确性.</p>
<p>参考资料：</p>
<p><a href="https://certbot.eff.org/" target="_blank" rel="external">certbot</a></p>
<p><a href="https://github.com/certbot/certbot" target="_blank" rel="external">certbot github</a></p>
<p><a href="http://letsencrypt.readthedocs.io/en/latest/using.html#getting-certificates-and-choosing-plugins" target="_blank" rel="external">letsencrypt docs</a></p>

      
    </div>

    <!-- S 打赏模块 -->
    <div class="pfan_payment" style="max-width: 500px;margin: 0 auto">
        <img src="http://img.pfan123.com/payment.png" alt="" style="width: 100%;height: 10%;">
    </div>
    <!-- E 打赏模块 -->


    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/letsencrypt、HTTPS、SSL、TSL/">letsencrypt、HTTPS、SSL、TSL</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
    
</article>











  
    <article id="post-Webhook 实践" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/10/Webhook 实践/" class="article-date">
  	<time datetime="2017-03-10T02:00:21.000Z" itemprop="datePublished">2017-03-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/10/Webhook 实践/">Webhook 进行网站自动化部署</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Webhook-是什么？"><a href="#Webhook-是什么？" class="headerlink" title="Webhook 是什么？"></a>Webhook 是什么？</h2><p><a href="https://developer.github.com/webhooks/" target="_blank" rel="external">Webhook</a>，也就是人们常说的钩子，是一个很有用的工具。Webhook 允许第三方应用监听 Github.com 上的特定事件，在这些事件发生时通过 HTTP POST 方式通知( 超时5秒) 到第三方应用指定的 Web URL。 例如项目有新的内容 Push，或是 Merge Request 有更新等。 WebHook 可方便用户实现自动部署，自动测试，自动打包，监控项目变化等。</p>
<p>如此一来，可以通过这种方式去自动完成一些重复性工作；比如，用 Webhook 来自动触发一些持续集成（CI）工具的运作，比如 <a href="https://github.com/integrations/travis-ci" target="_blank" rel="external">Travis CI</a>；又或者是通过 Webhook 去部署你的线上服务器。</p>
<h2 id="Webhook使用场景"><a href="#Webhook使用场景" class="headerlink" title="Webhook使用场景"></a>Webhook使用场景</h2><p>实际工作中，经常有这样的场景，本地提交代码到git仓库以后需要网站远程自动同步代码, 大概流程如下图： </p>
<p><img src="http://img.pfan123.com/webhook1.png" alt="Webhook"></p>
<h2 id="Webhook自动化部署"><a href="#Webhook自动化部署" class="headerlink" title="Webhook自动化部署"></a>Webhook自动化部署</h2><p>1.为了响应 Webhook 发出的请求，从而做一些我们想做的事情，我们得先实现一个响应服务器。本文采用 Node 来实现一个原型，你当然也可以用 PHP，python 等， 这里使用了<a href="https://github.com/rvagg/github-webhook-handler" target="_blank" rel="external">github-webhook-handler</a>插件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">const http = require(&apos;http&apos;)</span><br><span class="line">const createHandler = require(&apos;github-webhook-handler&apos;)</span><br><span class="line">const handler = createHandler(&#123; path: &apos;/webhook&apos;, secret: &apos;myhashsecret&apos; &#125;)</span><br><span class="line">const exec = require(&apos;child_process&apos;).exec</span><br><span class="line"></span><br><span class="line">var commands = [</span><br><span class="line">  &apos;cd .././blog&apos;,</span><br><span class="line">  &apos;git clean -df&apos;,</span><br><span class="line">  &apos;git pull&apos;</span><br><span class="line">].join(&apos; &amp;&amp; &apos;)</span><br><span class="line"></span><br><span class="line">http.createServer(function (req, res) &#123;</span><br><span class="line">  console.log(req.url)</span><br><span class="line">  handler(req, res, function (err) &#123;</span><br><span class="line">    res.statusCode = 404</span><br><span class="line">    res.end(&apos;no such location&apos;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).listen(7777)</span><br><span class="line"></span><br><span class="line">handler.on(&apos;error&apos;, function (err) &#123;</span><br><span class="line">  console.error(&apos;Error:&apos;, err.message)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">handler.on(&apos;push&apos;, function (event) &#123;</span><br><span class="line">  console.log(&apos;Received a push event for %s to %s&apos;,</span><br><span class="line">    event.payload.repository.name,</span><br><span class="line">    event.payload.ref)</span><br><span class="line"></span><br><span class="line">    //执行通关exec做操作，也可以尝试用sh脚本</span><br><span class="line">    exec(commands, function (error, stdout, stderr) &#123;</span><br><span class="line">      if (error) &#123;</span><br><span class="line">        console.log(error.stack);</span><br><span class="line">        console.log(&apos;Error code: &apos; + error.code);</span><br><span class="line">      &#125;</span><br><span class="line">      console.log(&apos;博客更新 deploy&apos;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">handler.on(&apos;issues&apos;, function (event) &#123;</span><br><span class="line">  console.log(&apos;Received an issue event for %s action=%s: #%d %s&apos;,</span><br><span class="line">    event.payload.repository.name,</span><br><span class="line">    event.payload.action,</span><br><span class="line">    event.payload.issue.number,</span><br><span class="line">    event.payload.issue.title)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>例如  <code>deploy.sh</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//执行通关exec做操作，也可以尝试用sh脚本</span><br><span class="line">exec(&apos;sh deploy.sh&apos;, function (error, stdout, stderr) &#123;</span><br><span class="line">  if (error) &#123;</span><br><span class="line">    console.log(error.stack);</span><br><span class="line">    console.log(&apos;Error code: &apos; + error.code);</span><br><span class="line">  &#125;</span><br><span class="line">  console.log(&apos;博客更新 deploy&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"> </span><br><span class="line">WEB_PATH=&apos;/www/blog/&apos;</span><br><span class="line"> </span><br><span class="line">echo &quot;Start deployment&quot;</span><br><span class="line"></span><br><span class="line">cd $WEB_PATH</span><br><span class="line">echo &quot;pulling source code...&quot;</span><br><span class="line">git reset --hard origin/master</span><br><span class="line">git clean -f</span><br><span class="line">git pull</span><br><span class="line">git checkout master</span><br><span class="line">echo &quot;Finished.&quot;</span><br></pre></td></tr></table></figure>
<h2 id="配置-Webhook"><a href="#配置-Webhook" class="headerlink" title="配置 Webhook"></a>配置 Webhook</h2><p>Webhook 的配置是十分简单的，首先进入你的 repo 主页，通过点击页面上的按钮 [settings] -&gt; [Webhooks &amp; service] 进入 Webhooks 配置主页面。也可以通过下面这个链接直接进入配置页面：</p>
<p><img src="http://img.pfan123.com/webhook2.png" alt="Webhook"></p>
<p>配置好 Webhook 后，Github 会发送一个 ping 来测试这个地址。如果成功了，那么这个 Webhook 前就会加上一个绿色的勾；如果你得到的是一个红色的叉，那就好好检查一下哪儿出问题了吧！</p>
<p><img src="http://img.pfan123.com/webhook3.png" alt="Webhook"></p>
<p>参考资料：</p>
<p><a href="https://developer.github.com/webhooks/" target="_blank" rel="external">Webhook</a></p>
<p><a href="https://coding.net/help/doc/git/webhook.html" target="_blank" rel="external">coding Webhook</a></p>
<p><a href="https://github.com/rvagg/github-webhook-handler" target="_blank" rel="external">github-webhook-handler</a></p>

      
    </div>

    <!-- S 打赏模块 -->
    <div class="pfan_payment" style="max-width: 500px;margin: 0 auto">
        <img src="http://img.pfan123.com/payment.png" alt="" style="width: 100%;height: 10%;">
    </div>
    <!-- E 打赏模块 -->


    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webhook，git/">Webhook，git</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
    
</article>











  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 pfan
    	</div>
      	<div class="footer-right">
      		<a href="//hexo.io/" target="_blank">Hexo</a>  Theme <a href="//github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a>
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="js/MathJax.js>
</script>


  </div>
</body>
</html>